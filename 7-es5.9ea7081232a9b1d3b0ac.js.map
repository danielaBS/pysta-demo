{"version":3,"sources":["webpack:///node_modules/firebase/node_modules/@firebase/installations/dist/index.esm.js","webpack:///node_modules/firebase/node_modules/@firebase/messaging/dist/index.esm.js","webpack:///node_modules/idb/build/idb.js"],"names":["ERROR_DESCRIPTION_MAP","ERROR_FACTORY","isServerError","error","code","includes","getInstallationsEndpoint","_a","INSTALLATIONS_API_URL","projectId","extractAuthTokenInfoFromResponse","response","token","requestStatus","expiresIn","responseExpiresIn","Number","replace","creationTime","Date","now","getErrorFromResponse","requestName","this","responseJson","errorData","label","json","sent","create","serverCode","serverMessage","message","serverStatus","status","getHeaders","Headers","Accept","apiKey","getHeadersWithAuth","appConfig","refreshToken","headers","append","INTERNAL_AUTH_VERSION","retryIfServerError","fn","result","createInstallationRequest","fid","endpoint","request","responseValue","_b","method","body","JSON","stringify","authVersion","appId","sdkVersion","fetch","ok","registrationStatus","authToken","sleep","ms","Promise","resolve","setTimeout","VALID_FID_PATTERN","generateFid","fidByteArray","Uint8Array","self","crypto","msCrypto","getRandomValues","array","btoa","String","fromCharCode","apply","substr","test","getKey","appName","fidChangeCallbacks","Map","fidChanged","key","callFidChangeCallbacks","channel","getBroadcastChannel","postMessage","closeBroadcastChannel","e_1","callbacks","get","callbacks_1","callbacks_1_1","next","done","value","e_1_1","call","broadcastChannel","BroadcastChannel","onmessage","e","data","size","close","instance","OBJECT_STORE_NAME","dbPromise","getDbPromise","openDb","upgradeDB","oldVersion","createObjectStore","set","db","tx","objectStore","oldValue","transaction","put","complete","remove","update","updateFn","store","newValue","getInstallationEntry","registrationPromise","installationEntry","oldEntry","clearTimedOutRequest","entryWithPromise","navigator","onLine","reject","inProgressEntry","registrationTime","registeredInstallationEntry","trys","push","customData","waitUntilFidRegistration","entry","updateInstallationRequest","generateAuthTokenRequest","platformLoggerProvider","platformLogger","getImmediate","optional","getPlatformInfoString","installation","refreshAuthToken","dependencies","forceRefresh","tokenPromise","isEntryRegistered","oldAuthToken","updateAuthTokenRequest","inProgressAuthToken","requestTime","updatedInstallationEntry","completeInstallationRegistration","deleteInstallationRequest","getMissingValueError","valueName","INTERNAL","registerComponent","container","app","getProvider","options","name","configKeys_1","configKeys_1_1","keyName","getId","console","getToken","delete","onIdChange","callback","callbackSet","Set","add","registerVersion","ERROR_MAP","DEFAULT_VAPID_KEY","MessageType","arrayToBase64","uint8Array","base64ToArray","base64String","base64","repeat","length","rawData","atob","outputArray","i","charCodeAt","migrateOldDatabase","senderId","tokenDetails","_this","indexedDB","databases","map","oldDetails","objectStoreNames","contains","index","clear","auth","p256dh","fcmToken","createTime","subscriptionOptions","swScope","vapidKey","deleteDb","checkTokenDetails","upgradeDb","dbGet","firebaseDependencies","oldTokenDetails","dbSet","dbRemove","requestGetToken","subscribeOptions","responseData","err_1","getBody","getEndpoint","errorInfo","requestUpdateToken","updateOptions","err_2","requestDeleteToken","unsubscribeOptions","err_3","ENDPOINT","installations","web","applicationPubKey","swRegistration","pushSubscription","Notification","permission","getPushSubscription","scope","getNewToken","isEndpointEqual","currentOptions","dbOptions","warn","updateToken","deleteToken","pushManager","getSubscription","unsubscribe","updatedToken","updatedTokenDetails","e_2","subscription","subscribe","userVisibleOnly","applicationServerKey","isConsoleMessage","SwController","isOnBackgroundMessageUsed","bgMessageHandler","addEventListener","waitUntil","onPush","onSubChange","onNotificationClick","Object","defineProperty","prototype","enumerable","configurable","setBackgroundMessageHandler","onBackgroundMessage","nextOrObserver","_c","registration","requestPermission","usePublicVapidKey","useServiceWorker","onMessage","onTokenRefresh","event","internalPayload","clientList","isNotificationShown","payload","err","getClientList","debug","TAG","some","client","visibilityState","url","startsWith","sendMessagePayloadInternalToWindows","notification","showNotification","wrapInternalPayload","from","collapseKey","collapse_key","messageId","fcm_message_id","messagePayloadInternal","title","image","fcmOptions","link","analyticsLabel","analytics_label","newSubscription","originUrl","action","stopImmediatePropagation","click_action","location","origin","URL","href","host","getWindowClient","clients","openWindow","focus","messageType","NOTIFICATION_CLICKED","isFirebaseMessaging","wrappedInternalPayload","clientList_1","clientList_1_1","clientUrl","PUSH_RECEIVED","clientList_2","clientList_2_1","e_2_1","matchAll","type","includeUncontrolled","notificationPayloadInternal","actions","maxActions","WindowController","onMessageCallback","serviceWorker","messageEventListener","dataPayload","assign","logEvent","getVapidKey","getSwReg","updateVapidKey","updateSwReg","serviceWorkerRegistration","registerDefaultSw","ServiceWorkerRegistration","register","browserErrorMessage","permissionResult","eventType","Error","analyticsProvider","message_id","message_name","message_time","message_device_time","Math","floor","NAMESPACE_EXPORTS","isSupported","hasOwnProperty","PushSubscription","window","cookieEnabled","messagingSenderId","setServiceProps","exports","toArray","arr","Array","slice","promisifyRequest","onsuccess","onerror","promisifyRequestCall","obj","args","p","then","promisifyCursorRequestCall","Cursor","proxyProperties","ProxyClass","targetProp","properties","forEach","prop","val","proxyRequestMethods","Constructor","arguments","proxyMethods","proxyCursorRequestMethods","Index","_index","cursor","_cursor","_request","ObjectStore","_store","Transaction","idbTransaction","_tx","oncomplete","onabort","UpgradeDB","_db","DB","IDBIndex","IDBCursor","methodName","createIndex","IDBObjectStore","IDBTransaction","IDBDatabase","funcName","nativeObject","getAll","query","count","items","iterateCursor","version","upgradeCallback","onupgradeneeded"],"mappings":"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","file":"x","sourcesContent":["import firebase from '@firebase/app';\nimport { Component } from '@firebase/component';\nimport { __awaiter, __generator, __spreadArray, __read, __values, __assign } from 'tslib';\nimport { ErrorFactory, FirebaseError } from '@firebase/util';\nimport { openDb } from 'idb';\n\nvar name = \"@firebase/installations\";\nvar version = \"0.4.32\";\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nvar PENDING_TIMEOUT_MS = 10000;\r\nvar PACKAGE_VERSION = \"w:\" + version;\r\nvar INTERNAL_AUTH_VERSION = 'FIS_v2';\r\nvar INSTALLATIONS_API_URL = 'https://firebaseinstallations.googleapis.com/v1';\r\nvar TOKEN_EXPIRATION_BUFFER = 60 * 60 * 1000; // One hour\r\nvar SERVICE = 'installations';\r\nvar SERVICE_NAME = 'Installations';\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nvar _a;\r\nvar ERROR_DESCRIPTION_MAP = (_a = {},\r\n    _a[\"missing-app-config-values\" /* MISSING_APP_CONFIG_VALUES */] = 'Missing App configuration value: \"{$valueName}\"',\r\n    _a[\"not-registered\" /* NOT_REGISTERED */] = 'Firebase Installation is not registered.',\r\n    _a[\"installation-not-found\" /* INSTALLATION_NOT_FOUND */] = 'Firebase Installation not found.',\r\n    _a[\"request-failed\" /* REQUEST_FAILED */] = '{$requestName} request failed with error \"{$serverCode} {$serverStatus}: {$serverMessage}\"',\r\n    _a[\"app-offline\" /* APP_OFFLINE */] = 'Could not process request. Application offline.',\r\n    _a[\"delete-pending-registration\" /* DELETE_PENDING_REGISTRATION */] = \"Can't delete installation while there is a pending registration request.\",\r\n    _a);\r\nvar ERROR_FACTORY = new ErrorFactory(SERVICE, SERVICE_NAME, ERROR_DESCRIPTION_MAP);\r\n/** Returns true if error is a FirebaseError that is based on an error from the server. */\r\nfunction isServerError(error) {\r\n    return (error instanceof FirebaseError &&\r\n        error.code.includes(\"request-failed\" /* REQUEST_FAILED */));\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nfunction getInstallationsEndpoint(_a) {\r\n    var projectId = _a.projectId;\r\n    return INSTALLATIONS_API_URL + \"/projects/\" + projectId + \"/installations\";\r\n}\r\nfunction extractAuthTokenInfoFromResponse(response) {\r\n    return {\r\n        token: response.token,\r\n        requestStatus: 2 /* COMPLETED */,\r\n        expiresIn: getExpiresInFromResponseExpiresIn(response.expiresIn),\r\n        creationTime: Date.now()\r\n    };\r\n}\r\nfunction getErrorFromResponse(requestName, response) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var responseJson, errorData;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0: return [4 /*yield*/, response.json()];\r\n                case 1:\r\n                    responseJson = _a.sent();\r\n                    errorData = responseJson.error;\r\n                    return [2 /*return*/, ERROR_FACTORY.create(\"request-failed\" /* REQUEST_FAILED */, {\r\n                            requestName: requestName,\r\n                            serverCode: errorData.code,\r\n                            serverMessage: errorData.message,\r\n                            serverStatus: errorData.status\r\n                        })];\r\n            }\r\n        });\r\n    });\r\n}\r\nfunction getHeaders(_a) {\r\n    var apiKey = _a.apiKey;\r\n    return new Headers({\r\n        'Content-Type': 'application/json',\r\n        Accept: 'application/json',\r\n        'x-goog-api-key': apiKey\r\n    });\r\n}\r\nfunction getHeadersWithAuth(appConfig, _a) {\r\n    var refreshToken = _a.refreshToken;\r\n    var headers = getHeaders(appConfig);\r\n    headers.append('Authorization', getAuthorizationHeader(refreshToken));\r\n    return headers;\r\n}\r\n/**\r\n * Calls the passed in fetch wrapper and returns the response.\r\n * If the returned response has a status of 5xx, re-runs the function once and\r\n * returns the response.\r\n */\r\nfunction retryIfServerError(fn) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var result;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0: return [4 /*yield*/, fn()];\r\n                case 1:\r\n                    result = _a.sent();\r\n                    if (result.status >= 500 && result.status < 600) {\r\n                        // Internal Server Error. Retry request.\r\n                        return [2 /*return*/, fn()];\r\n                    }\r\n                    return [2 /*return*/, result];\r\n            }\r\n        });\r\n    });\r\n}\r\nfunction getExpiresInFromResponseExpiresIn(responseExpiresIn) {\r\n    // This works because the server will never respond with fractions of a second.\r\n    return Number(responseExpiresIn.replace('s', '000'));\r\n}\r\nfunction getAuthorizationHeader(refreshToken) {\r\n    return INTERNAL_AUTH_VERSION + \" \" + refreshToken;\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nfunction createInstallationRequest(appConfig, _a) {\r\n    var fid = _a.fid;\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var endpoint, headers, body, request, response, responseValue, registeredInstallationEntry;\r\n        return __generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0:\r\n                    endpoint = getInstallationsEndpoint(appConfig);\r\n                    headers = getHeaders(appConfig);\r\n                    body = {\r\n                        fid: fid,\r\n                        authVersion: INTERNAL_AUTH_VERSION,\r\n                        appId: appConfig.appId,\r\n                        sdkVersion: PACKAGE_VERSION\r\n                    };\r\n                    request = {\r\n                        method: 'POST',\r\n                        headers: headers,\r\n                        body: JSON.stringify(body)\r\n                    };\r\n                    return [4 /*yield*/, retryIfServerError(function () { return fetch(endpoint, request); })];\r\n                case 1:\r\n                    response = _b.sent();\r\n                    if (!response.ok) return [3 /*break*/, 3];\r\n                    return [4 /*yield*/, response.json()];\r\n                case 2:\r\n                    responseValue = _b.sent();\r\n                    registeredInstallationEntry = {\r\n                        fid: responseValue.fid || fid,\r\n                        registrationStatus: 2 /* COMPLETED */,\r\n                        refreshToken: responseValue.refreshToken,\r\n                        authToken: extractAuthTokenInfoFromResponse(responseValue.authToken)\r\n                    };\r\n                    return [2 /*return*/, registeredInstallationEntry];\r\n                case 3: return [4 /*yield*/, getErrorFromResponse('Create Installation', response)];\r\n                case 4: throw _b.sent();\r\n            }\r\n        });\r\n    });\r\n}\n\n/**\r\n * @license\r\n * Copyright 2020 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n/** Returns a promise that resolves after given time passes. */\r\nfunction sleep(ms) {\r\n    return new Promise(function (resolve) {\r\n        setTimeout(resolve, ms);\r\n    });\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nfunction bufferToBase64UrlSafe(array) {\r\n    var b64 = btoa(String.fromCharCode.apply(String, __spreadArray([], __read(array))));\r\n    return b64.replace(/\\+/g, '-').replace(/\\//g, '_');\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nvar VALID_FID_PATTERN = /^[cdef][\\w-]{21}$/;\r\nvar INVALID_FID = '';\r\n/**\r\n * Generates a new FID using random values from Web Crypto API.\r\n * Returns an empty string if FID generation fails for any reason.\r\n */\r\nfunction generateFid() {\r\n    try {\r\n        // A valid FID has exactly 22 base64 characters, which is 132 bits, or 16.5\r\n        // bytes. our implementation generates a 17 byte array instead.\r\n        var fidByteArray = new Uint8Array(17);\r\n        var crypto_1 = self.crypto || self.msCrypto;\r\n        crypto_1.getRandomValues(fidByteArray);\r\n        // Replace the first 4 random bits with the constant FID header of 0b0111.\r\n        fidByteArray[0] = 112 + (fidByteArray[0] % 16);\r\n        var fid = encode(fidByteArray);\r\n        return VALID_FID_PATTERN.test(fid) ? fid : INVALID_FID;\r\n    }\r\n    catch (_a) {\r\n        // FID generation errored\r\n        return INVALID_FID;\r\n    }\r\n}\r\n/** Converts a FID Uint8Array to a base64 string representation. */\r\nfunction encode(fidByteArray) {\r\n    var b64String = bufferToBase64UrlSafe(fidByteArray);\r\n    // Remove the 23rd character that was added because of the extra 4 bits at the\r\n    // end of our 17 byte array, and the '=' padding.\r\n    return b64String.substr(0, 22);\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n/** Returns a string key that can be used to identify the app. */\r\nfunction getKey(appConfig) {\r\n    return appConfig.appName + \"!\" + appConfig.appId;\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nvar fidChangeCallbacks = new Map();\r\n/**\r\n * Calls the onIdChange callbacks with the new FID value, and broadcasts the\r\n * change to other tabs.\r\n */\r\nfunction fidChanged(appConfig, fid) {\r\n    var key = getKey(appConfig);\r\n    callFidChangeCallbacks(key, fid);\r\n    broadcastFidChange(key, fid);\r\n}\r\nfunction addCallback(appConfig, callback) {\r\n    // Open the broadcast channel if it's not already open,\r\n    // to be able to listen to change events from other tabs.\r\n    getBroadcastChannel();\r\n    var key = getKey(appConfig);\r\n    var callbackSet = fidChangeCallbacks.get(key);\r\n    if (!callbackSet) {\r\n        callbackSet = new Set();\r\n        fidChangeCallbacks.set(key, callbackSet);\r\n    }\r\n    callbackSet.add(callback);\r\n}\r\nfunction removeCallback(appConfig, callback) {\r\n    var key = getKey(appConfig);\r\n    var callbackSet = fidChangeCallbacks.get(key);\r\n    if (!callbackSet) {\r\n        return;\r\n    }\r\n    callbackSet.delete(callback);\r\n    if (callbackSet.size === 0) {\r\n        fidChangeCallbacks.delete(key);\r\n    }\r\n    // Close broadcast channel if there are no more callbacks.\r\n    closeBroadcastChannel();\r\n}\r\nfunction callFidChangeCallbacks(key, fid) {\r\n    var e_1, _a;\r\n    var callbacks = fidChangeCallbacks.get(key);\r\n    if (!callbacks) {\r\n        return;\r\n    }\r\n    try {\r\n        for (var callbacks_1 = __values(callbacks), callbacks_1_1 = callbacks_1.next(); !callbacks_1_1.done; callbacks_1_1 = callbacks_1.next()) {\r\n            var callback = callbacks_1_1.value;\r\n            callback(fid);\r\n        }\r\n    }\r\n    catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n    finally {\r\n        try {\r\n            if (callbacks_1_1 && !callbacks_1_1.done && (_a = callbacks_1.return)) _a.call(callbacks_1);\r\n        }\r\n        finally { if (e_1) throw e_1.error; }\r\n    }\r\n}\r\nfunction broadcastFidChange(key, fid) {\r\n    var channel = getBroadcastChannel();\r\n    if (channel) {\r\n        channel.postMessage({ key: key, fid: fid });\r\n    }\r\n    closeBroadcastChannel();\r\n}\r\nvar broadcastChannel = null;\r\n/** Opens and returns a BroadcastChannel if it is supported by the browser. */\r\nfunction getBroadcastChannel() {\r\n    if (!broadcastChannel && 'BroadcastChannel' in self) {\r\n        broadcastChannel = new BroadcastChannel('[Firebase] FID Change');\r\n        broadcastChannel.onmessage = function (e) {\r\n            callFidChangeCallbacks(e.data.key, e.data.fid);\r\n        };\r\n    }\r\n    return broadcastChannel;\r\n}\r\nfunction closeBroadcastChannel() {\r\n    if (fidChangeCallbacks.size === 0 && broadcastChannel) {\r\n        broadcastChannel.close();\r\n        broadcastChannel = null;\r\n    }\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nvar DATABASE_NAME = 'firebase-installations-database';\r\nvar DATABASE_VERSION = 1;\r\nvar OBJECT_STORE_NAME = 'firebase-installations-store';\r\nvar dbPromise = null;\r\nfunction getDbPromise() {\r\n    if (!dbPromise) {\r\n        dbPromise = openDb(DATABASE_NAME, DATABASE_VERSION, function (upgradeDB) {\r\n            // We don't use 'break' in this switch statement, the fall-through\r\n            // behavior is what we want, because if there are multiple versions between\r\n            // the old version and the current version, we want ALL the migrations\r\n            // that correspond to those versions to run, not only the last one.\r\n            // eslint-disable-next-line default-case\r\n            switch (upgradeDB.oldVersion) {\r\n                case 0:\r\n                    upgradeDB.createObjectStore(OBJECT_STORE_NAME);\r\n            }\r\n        });\r\n    }\r\n    return dbPromise;\r\n}\r\n/** Assigns or overwrites the record for the given key with the given value. */\r\nfunction set(appConfig, value) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var key, db, tx, objectStore, oldValue;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    key = getKey(appConfig);\r\n                    return [4 /*yield*/, getDbPromise()];\r\n                case 1:\r\n                    db = _a.sent();\r\n                    tx = db.transaction(OBJECT_STORE_NAME, 'readwrite');\r\n                    objectStore = tx.objectStore(OBJECT_STORE_NAME);\r\n                    return [4 /*yield*/, objectStore.get(key)];\r\n                case 2:\r\n                    oldValue = _a.sent();\r\n                    return [4 /*yield*/, objectStore.put(value, key)];\r\n                case 3:\r\n                    _a.sent();\r\n                    return [4 /*yield*/, tx.complete];\r\n                case 4:\r\n                    _a.sent();\r\n                    if (!oldValue || oldValue.fid !== value.fid) {\r\n                        fidChanged(appConfig, value.fid);\r\n                    }\r\n                    return [2 /*return*/, value];\r\n            }\r\n        });\r\n    });\r\n}\r\n/** Removes record(s) from the objectStore that match the given key. */\r\nfunction remove(appConfig) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var key, db, tx;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    key = getKey(appConfig);\r\n                    return [4 /*yield*/, getDbPromise()];\r\n                case 1:\r\n                    db = _a.sent();\r\n                    tx = db.transaction(OBJECT_STORE_NAME, 'readwrite');\r\n                    return [4 /*yield*/, tx.objectStore(OBJECT_STORE_NAME).delete(key)];\r\n                case 2:\r\n                    _a.sent();\r\n                    return [4 /*yield*/, tx.complete];\r\n                case 3:\r\n                    _a.sent();\r\n                    return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\n/**\r\n * Atomically updates a record with the result of updateFn, which gets\r\n * called with the current value. If newValue is undefined, the record is\r\n * deleted instead.\r\n * @return Updated value\r\n */\r\nfunction update(appConfig, updateFn) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var key, db, tx, store, oldValue, newValue;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    key = getKey(appConfig);\r\n                    return [4 /*yield*/, getDbPromise()];\r\n                case 1:\r\n                    db = _a.sent();\r\n                    tx = db.transaction(OBJECT_STORE_NAME, 'readwrite');\r\n                    store = tx.objectStore(OBJECT_STORE_NAME);\r\n                    return [4 /*yield*/, store.get(key)];\r\n                case 2:\r\n                    oldValue = _a.sent();\r\n                    newValue = updateFn(oldValue);\r\n                    if (!(newValue === undefined)) return [3 /*break*/, 4];\r\n                    return [4 /*yield*/, store.delete(key)];\r\n                case 3:\r\n                    _a.sent();\r\n                    return [3 /*break*/, 6];\r\n                case 4: return [4 /*yield*/, store.put(newValue, key)];\r\n                case 5:\r\n                    _a.sent();\r\n                    _a.label = 6;\r\n                case 6: return [4 /*yield*/, tx.complete];\r\n                case 7:\r\n                    _a.sent();\r\n                    if (newValue && (!oldValue || oldValue.fid !== newValue.fid)) {\r\n                        fidChanged(appConfig, newValue.fid);\r\n                    }\r\n                    return [2 /*return*/, newValue];\r\n            }\r\n        });\r\n    });\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n/**\r\n * Updates and returns the InstallationEntry from the database.\r\n * Also triggers a registration request if it is necessary and possible.\r\n */\r\nfunction getInstallationEntry(appConfig) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var registrationPromise, installationEntry;\r\n        var _a;\r\n        return __generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0: return [4 /*yield*/, update(appConfig, function (oldEntry) {\r\n                        var installationEntry = updateOrCreateInstallationEntry(oldEntry);\r\n                        var entryWithPromise = triggerRegistrationIfNecessary(appConfig, installationEntry);\r\n                        registrationPromise = entryWithPromise.registrationPromise;\r\n                        return entryWithPromise.installationEntry;\r\n                    })];\r\n                case 1:\r\n                    installationEntry = _b.sent();\r\n                    if (!(installationEntry.fid === INVALID_FID)) return [3 /*break*/, 3];\r\n                    _a = {};\r\n                    return [4 /*yield*/, registrationPromise];\r\n                case 2: \r\n                // FID generation failed. Waiting for the FID from the server.\r\n                return [2 /*return*/, (_a.installationEntry = _b.sent(), _a)];\r\n                case 3: return [2 /*return*/, {\r\n                        installationEntry: installationEntry,\r\n                        registrationPromise: registrationPromise\r\n                    }];\r\n            }\r\n        });\r\n    });\r\n}\r\n/**\r\n * Creates a new Installation Entry if one does not exist.\r\n * Also clears timed out pending requests.\r\n */\r\nfunction updateOrCreateInstallationEntry(oldEntry) {\r\n    var entry = oldEntry || {\r\n        fid: generateFid(),\r\n        registrationStatus: 0 /* NOT_STARTED */\r\n    };\r\n    return clearTimedOutRequest(entry);\r\n}\r\n/**\r\n * If the Firebase Installation is not registered yet, this will trigger the\r\n * registration and return an InProgressInstallationEntry.\r\n *\r\n * If registrationPromise does not exist, the installationEntry is guaranteed\r\n * to be registered.\r\n */\r\nfunction triggerRegistrationIfNecessary(appConfig, installationEntry) {\r\n    if (installationEntry.registrationStatus === 0 /* NOT_STARTED */) {\r\n        if (!navigator.onLine) {\r\n            // Registration required but app is offline.\r\n            var registrationPromiseWithError = Promise.reject(ERROR_FACTORY.create(\"app-offline\" /* APP_OFFLINE */));\r\n            return {\r\n                installationEntry: installationEntry,\r\n                registrationPromise: registrationPromiseWithError\r\n            };\r\n        }\r\n        // Try registering. Change status to IN_PROGRESS.\r\n        var inProgressEntry = {\r\n            fid: installationEntry.fid,\r\n            registrationStatus: 1 /* IN_PROGRESS */,\r\n            registrationTime: Date.now()\r\n        };\r\n        var registrationPromise = registerInstallation(appConfig, inProgressEntry);\r\n        return { installationEntry: inProgressEntry, registrationPromise: registrationPromise };\r\n    }\r\n    else if (installationEntry.registrationStatus === 1 /* IN_PROGRESS */) {\r\n        return {\r\n            installationEntry: installationEntry,\r\n            registrationPromise: waitUntilFidRegistration(appConfig)\r\n        };\r\n    }\r\n    else {\r\n        return { installationEntry: installationEntry };\r\n    }\r\n}\r\n/** This will be executed only once for each new Firebase Installation. */\r\nfunction registerInstallation(appConfig, installationEntry) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var registeredInstallationEntry, e_1;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    _a.trys.push([0, 2, , 7]);\r\n                    return [4 /*yield*/, createInstallationRequest(appConfig, installationEntry)];\r\n                case 1:\r\n                    registeredInstallationEntry = _a.sent();\r\n                    return [2 /*return*/, set(appConfig, registeredInstallationEntry)];\r\n                case 2:\r\n                    e_1 = _a.sent();\r\n                    if (!(isServerError(e_1) && e_1.customData.serverCode === 409)) return [3 /*break*/, 4];\r\n                    // Server returned a \"FID can not be used\" error.\r\n                    // Generate a new ID next time.\r\n                    return [4 /*yield*/, remove(appConfig)];\r\n                case 3:\r\n                    // Server returned a \"FID can not be used\" error.\r\n                    // Generate a new ID next time.\r\n                    _a.sent();\r\n                    return [3 /*break*/, 6];\r\n                case 4: \r\n                // Registration failed. Set FID as not registered.\r\n                return [4 /*yield*/, set(appConfig, {\r\n                        fid: installationEntry.fid,\r\n                        registrationStatus: 0 /* NOT_STARTED */\r\n                    })];\r\n                case 5:\r\n                    // Registration failed. Set FID as not registered.\r\n                    _a.sent();\r\n                    _a.label = 6;\r\n                case 6: throw e_1;\r\n                case 7: return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\n/** Call if FID registration is pending in another request. */\r\nfunction waitUntilFidRegistration(appConfig) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var entry, _a, installationEntry, registrationPromise;\r\n        return __generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0: return [4 /*yield*/, updateInstallationRequest(appConfig)];\r\n                case 1:\r\n                    entry = _b.sent();\r\n                    _b.label = 2;\r\n                case 2:\r\n                    if (!(entry.registrationStatus === 1 /* IN_PROGRESS */)) return [3 /*break*/, 5];\r\n                    // createInstallation request still in progress.\r\n                    return [4 /*yield*/, sleep(100)];\r\n                case 3:\r\n                    // createInstallation request still in progress.\r\n                    _b.sent();\r\n                    return [4 /*yield*/, updateInstallationRequest(appConfig)];\r\n                case 4:\r\n                    entry = _b.sent();\r\n                    return [3 /*break*/, 2];\r\n                case 5:\r\n                    if (!(entry.registrationStatus === 0 /* NOT_STARTED */)) return [3 /*break*/, 7];\r\n                    return [4 /*yield*/, getInstallationEntry(appConfig)];\r\n                case 6:\r\n                    _a = _b.sent(), installationEntry = _a.installationEntry, registrationPromise = _a.registrationPromise;\r\n                    if (registrationPromise) {\r\n                        return [2 /*return*/, registrationPromise];\r\n                    }\r\n                    else {\r\n                        // if there is no registrationPromise, entry is registered.\r\n                        return [2 /*return*/, installationEntry];\r\n                    }\r\n                case 7: return [2 /*return*/, entry];\r\n            }\r\n        });\r\n    });\r\n}\r\n/**\r\n * Called only if there is a CreateInstallation request in progress.\r\n *\r\n * Updates the InstallationEntry in the DB based on the status of the\r\n * CreateInstallation request.\r\n *\r\n * Returns the updated InstallationEntry.\r\n */\r\nfunction updateInstallationRequest(appConfig) {\r\n    return update(appConfig, function (oldEntry) {\r\n        if (!oldEntry) {\r\n            throw ERROR_FACTORY.create(\"installation-not-found\" /* INSTALLATION_NOT_FOUND */);\r\n        }\r\n        return clearTimedOutRequest(oldEntry);\r\n    });\r\n}\r\nfunction clearTimedOutRequest(entry) {\r\n    if (hasInstallationRequestTimedOut(entry)) {\r\n        return {\r\n            fid: entry.fid,\r\n            registrationStatus: 0 /* NOT_STARTED */\r\n        };\r\n    }\r\n    return entry;\r\n}\r\nfunction hasInstallationRequestTimedOut(installationEntry) {\r\n    return (installationEntry.registrationStatus === 1 /* IN_PROGRESS */ &&\r\n        installationEntry.registrationTime + PENDING_TIMEOUT_MS < Date.now());\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nfunction generateAuthTokenRequest(_a, installationEntry) {\r\n    var appConfig = _a.appConfig, platformLoggerProvider = _a.platformLoggerProvider;\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var endpoint, headers, platformLogger, body, request, response, responseValue, completedAuthToken;\r\n        return __generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0:\r\n                    endpoint = getGenerateAuthTokenEndpoint(appConfig, installationEntry);\r\n                    headers = getHeadersWithAuth(appConfig, installationEntry);\r\n                    platformLogger = platformLoggerProvider.getImmediate({\r\n                        optional: true\r\n                    });\r\n                    if (platformLogger) {\r\n                        headers.append('x-firebase-client', platformLogger.getPlatformInfoString());\r\n                    }\r\n                    body = {\r\n                        installation: {\r\n                            sdkVersion: PACKAGE_VERSION\r\n                        }\r\n                    };\r\n                    request = {\r\n                        method: 'POST',\r\n                        headers: headers,\r\n                        body: JSON.stringify(body)\r\n                    };\r\n                    return [4 /*yield*/, retryIfServerError(function () { return fetch(endpoint, request); })];\r\n                case 1:\r\n                    response = _b.sent();\r\n                    if (!response.ok) return [3 /*break*/, 3];\r\n                    return [4 /*yield*/, response.json()];\r\n                case 2:\r\n                    responseValue = _b.sent();\r\n                    completedAuthToken = extractAuthTokenInfoFromResponse(responseValue);\r\n                    return [2 /*return*/, completedAuthToken];\r\n                case 3: return [4 /*yield*/, getErrorFromResponse('Generate Auth Token', response)];\r\n                case 4: throw _b.sent();\r\n            }\r\n        });\r\n    });\r\n}\r\nfunction getGenerateAuthTokenEndpoint(appConfig, _a) {\r\n    var fid = _a.fid;\r\n    return getInstallationsEndpoint(appConfig) + \"/\" + fid + \"/authTokens:generate\";\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n/**\r\n * Returns a valid authentication token for the installation. Generates a new\r\n * token if one doesn't exist, is expired or about to expire.\r\n *\r\n * Should only be called if the Firebase Installation is registered.\r\n */\r\nfunction refreshAuthToken(dependencies, forceRefresh) {\r\n    if (forceRefresh === void 0) { forceRefresh = false; }\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var tokenPromise, entry, authToken, _a;\r\n        return __generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0: return [4 /*yield*/, update(dependencies.appConfig, function (oldEntry) {\r\n                        if (!isEntryRegistered(oldEntry)) {\r\n                            throw ERROR_FACTORY.create(\"not-registered\" /* NOT_REGISTERED */);\r\n                        }\r\n                        var oldAuthToken = oldEntry.authToken;\r\n                        if (!forceRefresh && isAuthTokenValid(oldAuthToken)) {\r\n                            // There is a valid token in the DB.\r\n                            return oldEntry;\r\n                        }\r\n                        else if (oldAuthToken.requestStatus === 1 /* IN_PROGRESS */) {\r\n                            // There already is a token request in progress.\r\n                            tokenPromise = waitUntilAuthTokenRequest(dependencies, forceRefresh);\r\n                            return oldEntry;\r\n                        }\r\n                        else {\r\n                            // No token or token expired.\r\n                            if (!navigator.onLine) {\r\n                                throw ERROR_FACTORY.create(\"app-offline\" /* APP_OFFLINE */);\r\n                            }\r\n                            var inProgressEntry = makeAuthTokenRequestInProgressEntry(oldEntry);\r\n                            tokenPromise = fetchAuthTokenFromServer(dependencies, inProgressEntry);\r\n                            return inProgressEntry;\r\n                        }\r\n                    })];\r\n                case 1:\r\n                    entry = _b.sent();\r\n                    if (!tokenPromise) return [3 /*break*/, 3];\r\n                    return [4 /*yield*/, tokenPromise];\r\n                case 2:\r\n                    _a = _b.sent();\r\n                    return [3 /*break*/, 4];\r\n                case 3:\r\n                    _a = entry.authToken;\r\n                    _b.label = 4;\r\n                case 4:\r\n                    authToken = _a;\r\n                    return [2 /*return*/, authToken];\r\n            }\r\n        });\r\n    });\r\n}\r\n/**\r\n * Call only if FID is registered and Auth Token request is in progress.\r\n *\r\n * Waits until the current pending request finishes. If the request times out,\r\n * tries once in this thread as well.\r\n */\r\nfunction waitUntilAuthTokenRequest(dependencies, forceRefresh) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var entry, authToken;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0: return [4 /*yield*/, updateAuthTokenRequest(dependencies.appConfig)];\r\n                case 1:\r\n                    entry = _a.sent();\r\n                    _a.label = 2;\r\n                case 2:\r\n                    if (!(entry.authToken.requestStatus === 1 /* IN_PROGRESS */)) return [3 /*break*/, 5];\r\n                    // generateAuthToken still in progress.\r\n                    return [4 /*yield*/, sleep(100)];\r\n                case 3:\r\n                    // generateAuthToken still in progress.\r\n                    _a.sent();\r\n                    return [4 /*yield*/, updateAuthTokenRequest(dependencies.appConfig)];\r\n                case 4:\r\n                    entry = _a.sent();\r\n                    return [3 /*break*/, 2];\r\n                case 5:\r\n                    authToken = entry.authToken;\r\n                    if (authToken.requestStatus === 0 /* NOT_STARTED */) {\r\n                        // The request timed out or failed in a different call. Try again.\r\n                        return [2 /*return*/, refreshAuthToken(dependencies, forceRefresh)];\r\n                    }\r\n                    else {\r\n                        return [2 /*return*/, authToken];\r\n                    }\r\n            }\r\n        });\r\n    });\r\n}\r\n/**\r\n * Called only if there is a GenerateAuthToken request in progress.\r\n *\r\n * Updates the InstallationEntry in the DB based on the status of the\r\n * GenerateAuthToken request.\r\n *\r\n * Returns the updated InstallationEntry.\r\n */\r\nfunction updateAuthTokenRequest(appConfig) {\r\n    return update(appConfig, function (oldEntry) {\r\n        if (!isEntryRegistered(oldEntry)) {\r\n            throw ERROR_FACTORY.create(\"not-registered\" /* NOT_REGISTERED */);\r\n        }\r\n        var oldAuthToken = oldEntry.authToken;\r\n        if (hasAuthTokenRequestTimedOut(oldAuthToken)) {\r\n            return __assign(__assign({}, oldEntry), { authToken: { requestStatus: 0 /* NOT_STARTED */ } });\r\n        }\r\n        return oldEntry;\r\n    });\r\n}\r\nfunction fetchAuthTokenFromServer(dependencies, installationEntry) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var authToken, updatedInstallationEntry, e_1, updatedInstallationEntry;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    _a.trys.push([0, 3, , 8]);\r\n                    return [4 /*yield*/, generateAuthTokenRequest(dependencies, installationEntry)];\r\n                case 1:\r\n                    authToken = _a.sent();\r\n                    updatedInstallationEntry = __assign(__assign({}, installationEntry), { authToken: authToken });\r\n                    return [4 /*yield*/, set(dependencies.appConfig, updatedInstallationEntry)];\r\n                case 2:\r\n                    _a.sent();\r\n                    return [2 /*return*/, authToken];\r\n                case 3:\r\n                    e_1 = _a.sent();\r\n                    if (!(isServerError(e_1) &&\r\n                        (e_1.customData.serverCode === 401 || e_1.customData.serverCode === 404))) return [3 /*break*/, 5];\r\n                    // Server returned a \"FID not found\" or a \"Invalid authentication\" error.\r\n                    // Generate a new ID next time.\r\n                    return [4 /*yield*/, remove(dependencies.appConfig)];\r\n                case 4:\r\n                    // Server returned a \"FID not found\" or a \"Invalid authentication\" error.\r\n                    // Generate a new ID next time.\r\n                    _a.sent();\r\n                    return [3 /*break*/, 7];\r\n                case 5:\r\n                    updatedInstallationEntry = __assign(__assign({}, installationEntry), { authToken: { requestStatus: 0 /* NOT_STARTED */ } });\r\n                    return [4 /*yield*/, set(dependencies.appConfig, updatedInstallationEntry)];\r\n                case 6:\r\n                    _a.sent();\r\n                    _a.label = 7;\r\n                case 7: throw e_1;\r\n                case 8: return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\nfunction isEntryRegistered(installationEntry) {\r\n    return (installationEntry !== undefined &&\r\n        installationEntry.registrationStatus === 2 /* COMPLETED */);\r\n}\r\nfunction isAuthTokenValid(authToken) {\r\n    return (authToken.requestStatus === 2 /* COMPLETED */ &&\r\n        !isAuthTokenExpired(authToken));\r\n}\r\nfunction isAuthTokenExpired(authToken) {\r\n    var now = Date.now();\r\n    return (now < authToken.creationTime ||\r\n        authToken.creationTime + authToken.expiresIn < now + TOKEN_EXPIRATION_BUFFER);\r\n}\r\n/** Returns an updated InstallationEntry with an InProgressAuthToken. */\r\nfunction makeAuthTokenRequestInProgressEntry(oldEntry) {\r\n    var inProgressAuthToken = {\r\n        requestStatus: 1 /* IN_PROGRESS */,\r\n        requestTime: Date.now()\r\n    };\r\n    return __assign(__assign({}, oldEntry), { authToken: inProgressAuthToken });\r\n}\r\nfunction hasAuthTokenRequestTimedOut(authToken) {\r\n    return (authToken.requestStatus === 1 /* IN_PROGRESS */ &&\r\n        authToken.requestTime + PENDING_TIMEOUT_MS < Date.now());\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nfunction getId(dependencies) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var _a, installationEntry, registrationPromise;\r\n        return __generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0: return [4 /*yield*/, getInstallationEntry(dependencies.appConfig)];\r\n                case 1:\r\n                    _a = _b.sent(), installationEntry = _a.installationEntry, registrationPromise = _a.registrationPromise;\r\n                    if (registrationPromise) {\r\n                        registrationPromise.catch(console.error);\r\n                    }\r\n                    else {\r\n                        // If the installation is already registered, update the authentication\r\n                        // token if needed.\r\n                        refreshAuthToken(dependencies).catch(console.error);\r\n                    }\r\n                    return [2 /*return*/, installationEntry.fid];\r\n            }\r\n        });\r\n    });\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nfunction getToken(dependencies, forceRefresh) {\r\n    if (forceRefresh === void 0) { forceRefresh = false; }\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var authToken;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0: return [4 /*yield*/, completeInstallationRegistration(dependencies.appConfig)];\r\n                case 1:\r\n                    _a.sent();\r\n                    return [4 /*yield*/, refreshAuthToken(dependencies, forceRefresh)];\r\n                case 2:\r\n                    authToken = _a.sent();\r\n                    return [2 /*return*/, authToken.token];\r\n            }\r\n        });\r\n    });\r\n}\r\nfunction completeInstallationRegistration(appConfig) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var registrationPromise;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0: return [4 /*yield*/, getInstallationEntry(appConfig)];\r\n                case 1:\r\n                    registrationPromise = (_a.sent()).registrationPromise;\r\n                    if (!registrationPromise) return [3 /*break*/, 3];\r\n                    // A createInstallation request is in progress. Wait until it finishes.\r\n                    return [4 /*yield*/, registrationPromise];\r\n                case 2:\r\n                    // A createInstallation request is in progress. Wait until it finishes.\r\n                    _a.sent();\r\n                    _a.label = 3;\r\n                case 3: return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nfunction deleteInstallationRequest(appConfig, installationEntry) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var endpoint, headers, request, response;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    endpoint = getDeleteEndpoint(appConfig, installationEntry);\r\n                    headers = getHeadersWithAuth(appConfig, installationEntry);\r\n                    request = {\r\n                        method: 'DELETE',\r\n                        headers: headers\r\n                    };\r\n                    return [4 /*yield*/, retryIfServerError(function () { return fetch(endpoint, request); })];\r\n                case 1:\r\n                    response = _a.sent();\r\n                    if (!!response.ok) return [3 /*break*/, 3];\r\n                    return [4 /*yield*/, getErrorFromResponse('Delete Installation', response)];\r\n                case 2: throw _a.sent();\r\n                case 3: return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\nfunction getDeleteEndpoint(appConfig, _a) {\r\n    var fid = _a.fid;\r\n    return getInstallationsEndpoint(appConfig) + \"/\" + fid;\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nfunction deleteInstallation(dependencies) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var appConfig, entry;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    appConfig = dependencies.appConfig;\r\n                    return [4 /*yield*/, update(appConfig, function (oldEntry) {\r\n                            if (oldEntry && oldEntry.registrationStatus === 0 /* NOT_STARTED */) {\r\n                                // Delete the unregistered entry without sending a deleteInstallation request.\r\n                                return undefined;\r\n                            }\r\n                            return oldEntry;\r\n                        })];\r\n                case 1:\r\n                    entry = _a.sent();\r\n                    if (!entry) return [3 /*break*/, 6];\r\n                    if (!(entry.registrationStatus === 1 /* IN_PROGRESS */)) return [3 /*break*/, 2];\r\n                    // Can't delete while trying to register.\r\n                    throw ERROR_FACTORY.create(\"delete-pending-registration\" /* DELETE_PENDING_REGISTRATION */);\r\n                case 2:\r\n                    if (!(entry.registrationStatus === 2 /* COMPLETED */)) return [3 /*break*/, 6];\r\n                    if (!!navigator.onLine) return [3 /*break*/, 3];\r\n                    throw ERROR_FACTORY.create(\"app-offline\" /* APP_OFFLINE */);\r\n                case 3: return [4 /*yield*/, deleteInstallationRequest(appConfig, entry)];\r\n                case 4:\r\n                    _a.sent();\r\n                    return [4 /*yield*/, remove(appConfig)];\r\n                case 5:\r\n                    _a.sent();\r\n                    _a.label = 6;\r\n                case 6: return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n/**\r\n * Sets a new callback that will get called when Installation ID changes.\r\n * Returns an unsubscribe function that will remove the callback when called.\r\n */\r\nfunction onIdChange(_a, callback) {\r\n    var appConfig = _a.appConfig;\r\n    addCallback(appConfig, callback);\r\n    return function () {\r\n        removeCallback(appConfig, callback);\r\n    };\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nfunction extractAppConfig(app) {\r\n    var e_1, _a;\r\n    if (!app || !app.options) {\r\n        throw getMissingValueError('App Configuration');\r\n    }\r\n    if (!app.name) {\r\n        throw getMissingValueError('App Name');\r\n    }\r\n    // Required app config keys\r\n    var configKeys = [\r\n        'projectId',\r\n        'apiKey',\r\n        'appId'\r\n    ];\r\n    try {\r\n        for (var configKeys_1 = __values(configKeys), configKeys_1_1 = configKeys_1.next(); !configKeys_1_1.done; configKeys_1_1 = configKeys_1.next()) {\r\n            var keyName = configKeys_1_1.value;\r\n            if (!app.options[keyName]) {\r\n                throw getMissingValueError(keyName);\r\n            }\r\n        }\r\n    }\r\n    catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n    finally {\r\n        try {\r\n            if (configKeys_1_1 && !configKeys_1_1.done && (_a = configKeys_1.return)) _a.call(configKeys_1);\r\n        }\r\n        finally { if (e_1) throw e_1.error; }\r\n    }\r\n    return {\r\n        appName: app.name,\r\n        projectId: app.options.projectId,\r\n        apiKey: app.options.apiKey,\r\n        appId: app.options.appId\r\n    };\r\n}\r\nfunction getMissingValueError(valueName) {\r\n    return ERROR_FACTORY.create(\"missing-app-config-values\" /* MISSING_APP_CONFIG_VALUES */, {\r\n        valueName: valueName\r\n    });\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nfunction registerInstallations(instance) {\r\n    var installationsName = 'installations';\r\n    instance.INTERNAL.registerComponent(new Component(installationsName, function (container) {\r\n        var app = container.getProvider('app').getImmediate();\r\n        // Throws if app isn't configured properly.\r\n        var appConfig = extractAppConfig(app);\r\n        var platformLoggerProvider = container.getProvider('platform-logger');\r\n        var dependencies = {\r\n            appConfig: appConfig,\r\n            platformLoggerProvider: platformLoggerProvider\r\n        };\r\n        var installations = {\r\n            app: app,\r\n            getId: function () { return getId(dependencies); },\r\n            getToken: function (forceRefresh) {\r\n                return getToken(dependencies, forceRefresh);\r\n            },\r\n            delete: function () { return deleteInstallation(dependencies); },\r\n            onIdChange: function (callback) {\r\n                return onIdChange(dependencies, callback);\r\n            }\r\n        };\r\n        return installations;\r\n    }, \"PUBLIC\" /* PUBLIC */));\r\n    instance.registerVersion(name, version);\r\n}\r\nregisterInstallations(firebase);\n\nexport { registerInstallations };\n//# sourceMappingURL=index.esm.js.map\n","import '@firebase/installations';\nimport { Component } from '@firebase/component';\nimport { ErrorFactory } from '@firebase/util';\nimport { __spreadArray, __read, __awaiter, __generator, __assign, __values } from 'tslib';\nimport { deleteDb, openDb } from 'idb';\nimport firebase from '@firebase/app';\n\n/**\r\n * @license\r\n * Copyright 2017 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nvar _a;\r\nvar ERROR_MAP = (_a = {},\r\n    _a[\"missing-app-config-values\" /* MISSING_APP_CONFIG_VALUES */] = 'Missing App configuration value: \"{$valueName}\"',\r\n    _a[\"only-available-in-window\" /* AVAILABLE_IN_WINDOW */] = 'This method is available in a Window context.',\r\n    _a[\"only-available-in-sw\" /* AVAILABLE_IN_SW */] = 'This method is available in a service worker context.',\r\n    _a[\"permission-default\" /* PERMISSION_DEFAULT */] = 'The notification permission was not granted and dismissed instead.',\r\n    _a[\"permission-blocked\" /* PERMISSION_BLOCKED */] = 'The notification permission was not granted and blocked instead.',\r\n    _a[\"unsupported-browser\" /* UNSUPPORTED_BROWSER */] = \"This browser doesn't support the API's required to use the firebase SDK.\",\r\n    _a[\"failed-service-worker-registration\" /* FAILED_DEFAULT_REGISTRATION */] = 'We are unable to register the default service worker. {$browserErrorMessage}',\r\n    _a[\"token-subscribe-failed\" /* TOKEN_SUBSCRIBE_FAILED */] = 'A problem occurred while subscribing the user to FCM: {$errorInfo}',\r\n    _a[\"token-subscribe-no-token\" /* TOKEN_SUBSCRIBE_NO_TOKEN */] = 'FCM returned no token when subscribing the user to push.',\r\n    _a[\"token-unsubscribe-failed\" /* TOKEN_UNSUBSCRIBE_FAILED */] = 'A problem occurred while unsubscribing the ' +\r\n        'user from FCM: {$errorInfo}',\r\n    _a[\"token-update-failed\" /* TOKEN_UPDATE_FAILED */] = 'A problem occurred while updating the user from FCM: {$errorInfo}',\r\n    _a[\"token-update-no-token\" /* TOKEN_UPDATE_NO_TOKEN */] = 'FCM returned no token when updating the user to push.',\r\n    _a[\"use-sw-after-get-token\" /* USE_SW_AFTER_GET_TOKEN */] = 'The useServiceWorker() method may only be called once and must be ' +\r\n        'called before calling getToken() to ensure your service worker is used.',\r\n    _a[\"invalid-sw-registration\" /* INVALID_SW_REGISTRATION */] = 'The input to useServiceWorker() must be a ServiceWorkerRegistration.',\r\n    _a[\"invalid-bg-handler\" /* INVALID_BG_HANDLER */] = 'The input to setBackgroundMessageHandler() must be a function.',\r\n    _a[\"invalid-vapid-key\" /* INVALID_VAPID_KEY */] = 'The public VAPID key must be a string.',\r\n    _a[\"use-vapid-key-after-get-token\" /* USE_VAPID_KEY_AFTER_GET_TOKEN */] = 'The usePublicVapidKey() method may only be called once and must be ' +\r\n        'called before calling getToken() to ensure your VAPID key is used.',\r\n    _a);\r\nvar ERROR_FACTORY = new ErrorFactory('messaging', 'Messaging', ERROR_MAP);\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nvar DEFAULT_SW_PATH = '/firebase-messaging-sw.js';\r\nvar DEFAULT_SW_SCOPE = '/firebase-cloud-messaging-push-scope';\r\nvar DEFAULT_VAPID_KEY = 'BDOU99-h67HcA6JeFXHbSNMu7e2yNNu3RzoMj8TM4W88jITfq7ZmPvIM1Iv-4_l2LxQcYwhqby2xGpWwzjfAnG4';\r\nvar ENDPOINT = 'https://fcmregistrations.googleapis.com/v1';\r\n// Key of FCM Payload in Notification's data field.\r\nvar FCM_MSG = 'FCM_MSG';\r\nvar TAG = 'FirebaseMessaging: ';\r\n// Set to '1' if Analytics is enabled for the campaign\r\nvar CONSOLE_CAMPAIGN_ANALYTICS_ENABLED = 'google.c.a.e';\r\nvar CONSOLE_CAMPAIGN_ID = 'google.c.a.c_id';\r\nvar CONSOLE_CAMPAIGN_TIME = 'google.c.a.ts';\r\nvar CONSOLE_CAMPAIGN_NAME = 'google.c.a.c_l';\r\n// Due to the fact that onBackgroundMessage can't be awaited (to support rxjs), a silent push\r\n// warning might be shown by the browser if the callback fails to completes by the end of onPush.\r\n// Experiments were ran to determine the majority onBackground message clock time. This brief\r\n// blocking time would allow majority of the onBackgroundMessage callback to finish.\r\nvar BACKGROUND_HANDLE_EXECUTION_TIME_LIMIT_MS = 1000;\r\n// Preparation time for client to initialize and set up the message handler.\r\nvar FOREGROUND_HANDLE_PREPARATION_TIME_MS = 3000;\n\n/**\r\n * @license\r\n * Copyright 2018 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\r\n * in compliance with the License. You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software distributed under the License\r\n * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\r\n * or implied. See the License for the specific language governing permissions and limitations under\r\n * the License.\r\n */\r\nvar MessageType;\r\n(function (MessageType) {\r\n    MessageType[\"PUSH_RECEIVED\"] = \"push-received\";\r\n    MessageType[\"NOTIFICATION_CLICKED\"] = \"notification-clicked\";\r\n})(MessageType || (MessageType = {}));\n\n/**\r\n * @license\r\n * Copyright 2017 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nfunction arrayToBase64(array) {\r\n    var uint8Array = new Uint8Array(array);\r\n    var base64String = btoa(String.fromCharCode.apply(String, __spreadArray([], __read(uint8Array))));\r\n    return base64String.replace(/=/g, '').replace(/\\+/g, '-').replace(/\\//g, '_');\r\n}\r\nfunction base64ToArray(base64String) {\r\n    var padding = '='.repeat((4 - (base64String.length % 4)) % 4);\r\n    var base64 = (base64String + padding)\r\n        .replace(/\\-/g, '+')\r\n        .replace(/_/g, '/');\r\n    var rawData = atob(base64);\r\n    var outputArray = new Uint8Array(rawData.length);\r\n    for (var i = 0; i < rawData.length; ++i) {\r\n        outputArray[i] = rawData.charCodeAt(i);\r\n    }\r\n    return outputArray;\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nvar OLD_DB_NAME = 'fcm_token_details_db';\r\n/**\r\n * The last DB version of 'fcm_token_details_db' was 4. This is one higher, so that the upgrade\r\n * callback is called for all versions of the old DB.\r\n */\r\nvar OLD_DB_VERSION = 5;\r\nvar OLD_OBJECT_STORE_NAME = 'fcm_token_object_Store';\r\nfunction migrateOldDatabase(senderId) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var databases, dbNames, tokenDetails, db;\r\n        var _this = this;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    if (!('databases' in indexedDB)) return [3 /*break*/, 2];\r\n                    return [4 /*yield*/, indexedDB.databases()];\r\n                case 1:\r\n                    databases = _a.sent();\r\n                    dbNames = databases.map(function (db) { return db.name; });\r\n                    if (!dbNames.includes(OLD_DB_NAME)) {\r\n                        // old DB didn't exist, no need to open.\r\n                        return [2 /*return*/, null];\r\n                    }\r\n                    _a.label = 2;\r\n                case 2:\r\n                    tokenDetails = null;\r\n                    return [4 /*yield*/, openDb(OLD_DB_NAME, OLD_DB_VERSION, function (db) { return __awaiter(_this, void 0, void 0, function () {\r\n                            var objectStore, value, oldDetails, oldDetails, oldDetails;\r\n                            var _a;\r\n                            return __generator(this, function (_b) {\r\n                                switch (_b.label) {\r\n                                    case 0:\r\n                                        if (db.oldVersion < 2) {\r\n                                            // Database too old, skip migration.\r\n                                            return [2 /*return*/];\r\n                                        }\r\n                                        if (!db.objectStoreNames.contains(OLD_OBJECT_STORE_NAME)) {\r\n                                            // Database did not exist. Nothing to do.\r\n                                            return [2 /*return*/];\r\n                                        }\r\n                                        objectStore = db.transaction.objectStore(OLD_OBJECT_STORE_NAME);\r\n                                        return [4 /*yield*/, objectStore.index('fcmSenderId').get(senderId)];\r\n                                    case 1:\r\n                                        value = _b.sent();\r\n                                        return [4 /*yield*/, objectStore.clear()];\r\n                                    case 2:\r\n                                        _b.sent();\r\n                                        if (!value) {\r\n                                            // No entry in the database, nothing to migrate.\r\n                                            return [2 /*return*/];\r\n                                        }\r\n                                        if (db.oldVersion === 2) {\r\n                                            oldDetails = value;\r\n                                            if (!oldDetails.auth || !oldDetails.p256dh || !oldDetails.endpoint) {\r\n                                                return [2 /*return*/];\r\n                                            }\r\n                                            tokenDetails = {\r\n                                                token: oldDetails.fcmToken,\r\n                                                createTime: (_a = oldDetails.createTime) !== null && _a !== void 0 ? _a : Date.now(),\r\n                                                subscriptionOptions: {\r\n                                                    auth: oldDetails.auth,\r\n                                                    p256dh: oldDetails.p256dh,\r\n                                                    endpoint: oldDetails.endpoint,\r\n                                                    swScope: oldDetails.swScope,\r\n                                                    vapidKey: typeof oldDetails.vapidKey === 'string'\r\n                                                        ? oldDetails.vapidKey\r\n                                                        : arrayToBase64(oldDetails.vapidKey)\r\n                                                }\r\n                                            };\r\n                                        }\r\n                                        else if (db.oldVersion === 3) {\r\n                                            oldDetails = value;\r\n                                            tokenDetails = {\r\n                                                token: oldDetails.fcmToken,\r\n                                                createTime: oldDetails.createTime,\r\n                                                subscriptionOptions: {\r\n                                                    auth: arrayToBase64(oldDetails.auth),\r\n                                                    p256dh: arrayToBase64(oldDetails.p256dh),\r\n                                                    endpoint: oldDetails.endpoint,\r\n                                                    swScope: oldDetails.swScope,\r\n                                                    vapidKey: arrayToBase64(oldDetails.vapidKey)\r\n                                                }\r\n                                            };\r\n                                        }\r\n                                        else if (db.oldVersion === 4) {\r\n                                            oldDetails = value;\r\n                                            tokenDetails = {\r\n                                                token: oldDetails.fcmToken,\r\n                                                createTime: oldDetails.createTime,\r\n                                                subscriptionOptions: {\r\n                                                    auth: arrayToBase64(oldDetails.auth),\r\n                                                    p256dh: arrayToBase64(oldDetails.p256dh),\r\n                                                    endpoint: oldDetails.endpoint,\r\n                                                    swScope: oldDetails.swScope,\r\n                                                    vapidKey: arrayToBase64(oldDetails.vapidKey)\r\n                                                }\r\n                                            };\r\n                                        }\r\n                                        return [2 /*return*/];\r\n                                }\r\n                            });\r\n                        }); })];\r\n                case 3:\r\n                    db = _a.sent();\r\n                    db.close();\r\n                    // Delete all old databases.\r\n                    return [4 /*yield*/, deleteDb(OLD_DB_NAME)];\r\n                case 4:\r\n                    // Delete all old databases.\r\n                    _a.sent();\r\n                    return [4 /*yield*/, deleteDb('fcm_vapid_details_db')];\r\n                case 5:\r\n                    _a.sent();\r\n                    return [4 /*yield*/, deleteDb('undefined')];\r\n                case 6:\r\n                    _a.sent();\r\n                    return [2 /*return*/, checkTokenDetails(tokenDetails) ? tokenDetails : null];\r\n            }\r\n        });\r\n    });\r\n}\r\nfunction checkTokenDetails(tokenDetails) {\r\n    if (!tokenDetails || !tokenDetails.subscriptionOptions) {\r\n        return false;\r\n    }\r\n    var subscriptionOptions = tokenDetails.subscriptionOptions;\r\n    return (typeof tokenDetails.createTime === 'number' &&\r\n        tokenDetails.createTime > 0 &&\r\n        typeof tokenDetails.token === 'string' &&\r\n        tokenDetails.token.length > 0 &&\r\n        typeof subscriptionOptions.auth === 'string' &&\r\n        subscriptionOptions.auth.length > 0 &&\r\n        typeof subscriptionOptions.p256dh === 'string' &&\r\n        subscriptionOptions.p256dh.length > 0 &&\r\n        typeof subscriptionOptions.endpoint === 'string' &&\r\n        subscriptionOptions.endpoint.length > 0 &&\r\n        typeof subscriptionOptions.swScope === 'string' &&\r\n        subscriptionOptions.swScope.length > 0 &&\r\n        typeof subscriptionOptions.vapidKey === 'string' &&\r\n        subscriptionOptions.vapidKey.length > 0);\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n// Exported for tests.\r\nvar DATABASE_NAME = 'firebase-messaging-database';\r\nvar DATABASE_VERSION = 1;\r\nvar OBJECT_STORE_NAME = 'firebase-messaging-store';\r\nvar dbPromise = null;\r\nfunction getDbPromise() {\r\n    if (!dbPromise) {\r\n        dbPromise = openDb(DATABASE_NAME, DATABASE_VERSION, function (upgradeDb) {\r\n            // We don't use 'break' in this switch statement, the fall-through behavior is what we want,\r\n            // because if there are multiple versions between the old version and the current version, we\r\n            // want ALL the migrations that correspond to those versions to run, not only the last one.\r\n            // eslint-disable-next-line default-case\r\n            switch (upgradeDb.oldVersion) {\r\n                case 0:\r\n                    upgradeDb.createObjectStore(OBJECT_STORE_NAME);\r\n            }\r\n        });\r\n    }\r\n    return dbPromise;\r\n}\r\n/** Gets record(s) from the objectStore that match the given key. */\r\nfunction dbGet(firebaseDependencies) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var key, db, tokenDetails, oldTokenDetails;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    key = getKey(firebaseDependencies);\r\n                    return [4 /*yield*/, getDbPromise()];\r\n                case 1:\r\n                    db = _a.sent();\r\n                    return [4 /*yield*/, db\r\n                            .transaction(OBJECT_STORE_NAME)\r\n                            .objectStore(OBJECT_STORE_NAME)\r\n                            .get(key)];\r\n                case 2:\r\n                    tokenDetails = _a.sent();\r\n                    if (!tokenDetails) return [3 /*break*/, 3];\r\n                    return [2 /*return*/, tokenDetails];\r\n                case 3: return [4 /*yield*/, migrateOldDatabase(firebaseDependencies.appConfig.senderId)];\r\n                case 4:\r\n                    oldTokenDetails = _a.sent();\r\n                    if (!oldTokenDetails) return [3 /*break*/, 6];\r\n                    return [4 /*yield*/, dbSet(firebaseDependencies, oldTokenDetails)];\r\n                case 5:\r\n                    _a.sent();\r\n                    return [2 /*return*/, oldTokenDetails];\r\n                case 6: return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\n/** Assigns or overwrites the record for the given key with the given value. */\r\nfunction dbSet(firebaseDependencies, tokenDetails) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var key, db, tx;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    key = getKey(firebaseDependencies);\r\n                    return [4 /*yield*/, getDbPromise()];\r\n                case 1:\r\n                    db = _a.sent();\r\n                    tx = db.transaction(OBJECT_STORE_NAME, 'readwrite');\r\n                    return [4 /*yield*/, tx.objectStore(OBJECT_STORE_NAME).put(tokenDetails, key)];\r\n                case 2:\r\n                    _a.sent();\r\n                    return [4 /*yield*/, tx.complete];\r\n                case 3:\r\n                    _a.sent();\r\n                    return [2 /*return*/, tokenDetails];\r\n            }\r\n        });\r\n    });\r\n}\r\n/** Removes record(s) from the objectStore that match the given key. */\r\nfunction dbRemove(firebaseDependencies) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var key, db, tx;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    key = getKey(firebaseDependencies);\r\n                    return [4 /*yield*/, getDbPromise()];\r\n                case 1:\r\n                    db = _a.sent();\r\n                    tx = db.transaction(OBJECT_STORE_NAME, 'readwrite');\r\n                    return [4 /*yield*/, tx.objectStore(OBJECT_STORE_NAME).delete(key)];\r\n                case 2:\r\n                    _a.sent();\r\n                    return [4 /*yield*/, tx.complete];\r\n                case 3:\r\n                    _a.sent();\r\n                    return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\nfunction getKey(_a) {\r\n    var appConfig = _a.appConfig;\r\n    return appConfig.appId;\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nfunction requestGetToken(firebaseDependencies, subscriptionOptions) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var headers, body, subscribeOptions, responseData, response, err_1, message;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0: return [4 /*yield*/, getHeaders(firebaseDependencies)];\r\n                case 1:\r\n                    headers = _a.sent();\r\n                    body = getBody(subscriptionOptions);\r\n                    subscribeOptions = {\r\n                        method: 'POST',\r\n                        headers: headers,\r\n                        body: JSON.stringify(body)\r\n                    };\r\n                    _a.label = 2;\r\n                case 2:\r\n                    _a.trys.push([2, 5, , 6]);\r\n                    return [4 /*yield*/, fetch(getEndpoint(firebaseDependencies.appConfig), subscribeOptions)];\r\n                case 3:\r\n                    response = _a.sent();\r\n                    return [4 /*yield*/, response.json()];\r\n                case 4:\r\n                    responseData = _a.sent();\r\n                    return [3 /*break*/, 6];\r\n                case 5:\r\n                    err_1 = _a.sent();\r\n                    throw ERROR_FACTORY.create(\"token-subscribe-failed\" /* TOKEN_SUBSCRIBE_FAILED */, {\r\n                        errorInfo: err_1\r\n                    });\r\n                case 6:\r\n                    if (responseData.error) {\r\n                        message = responseData.error.message;\r\n                        throw ERROR_FACTORY.create(\"token-subscribe-failed\" /* TOKEN_SUBSCRIBE_FAILED */, {\r\n                            errorInfo: message\r\n                        });\r\n                    }\r\n                    if (!responseData.token) {\r\n                        throw ERROR_FACTORY.create(\"token-subscribe-no-token\" /* TOKEN_SUBSCRIBE_NO_TOKEN */);\r\n                    }\r\n                    return [2 /*return*/, responseData.token];\r\n            }\r\n        });\r\n    });\r\n}\r\nfunction requestUpdateToken(firebaseDependencies, tokenDetails) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var headers, body, updateOptions, responseData, response, err_2, message;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0: return [4 /*yield*/, getHeaders(firebaseDependencies)];\r\n                case 1:\r\n                    headers = _a.sent();\r\n                    body = getBody(tokenDetails.subscriptionOptions);\r\n                    updateOptions = {\r\n                        method: 'PATCH',\r\n                        headers: headers,\r\n                        body: JSON.stringify(body)\r\n                    };\r\n                    _a.label = 2;\r\n                case 2:\r\n                    _a.trys.push([2, 5, , 6]);\r\n                    return [4 /*yield*/, fetch(getEndpoint(firebaseDependencies.appConfig) + \"/\" + tokenDetails.token, updateOptions)];\r\n                case 3:\r\n                    response = _a.sent();\r\n                    return [4 /*yield*/, response.json()];\r\n                case 4:\r\n                    responseData = _a.sent();\r\n                    return [3 /*break*/, 6];\r\n                case 5:\r\n                    err_2 = _a.sent();\r\n                    throw ERROR_FACTORY.create(\"token-update-failed\" /* TOKEN_UPDATE_FAILED */, {\r\n                        errorInfo: err_2\r\n                    });\r\n                case 6:\r\n                    if (responseData.error) {\r\n                        message = responseData.error.message;\r\n                        throw ERROR_FACTORY.create(\"token-update-failed\" /* TOKEN_UPDATE_FAILED */, {\r\n                            errorInfo: message\r\n                        });\r\n                    }\r\n                    if (!responseData.token) {\r\n                        throw ERROR_FACTORY.create(\"token-update-no-token\" /* TOKEN_UPDATE_NO_TOKEN */);\r\n                    }\r\n                    return [2 /*return*/, responseData.token];\r\n            }\r\n        });\r\n    });\r\n}\r\nfunction requestDeleteToken(firebaseDependencies, token) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var headers, unsubscribeOptions, response, responseData, message, err_3;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0: return [4 /*yield*/, getHeaders(firebaseDependencies)];\r\n                case 1:\r\n                    headers = _a.sent();\r\n                    unsubscribeOptions = {\r\n                        method: 'DELETE',\r\n                        headers: headers\r\n                    };\r\n                    _a.label = 2;\r\n                case 2:\r\n                    _a.trys.push([2, 5, , 6]);\r\n                    return [4 /*yield*/, fetch(getEndpoint(firebaseDependencies.appConfig) + \"/\" + token, unsubscribeOptions)];\r\n                case 3:\r\n                    response = _a.sent();\r\n                    return [4 /*yield*/, response.json()];\r\n                case 4:\r\n                    responseData = _a.sent();\r\n                    if (responseData.error) {\r\n                        message = responseData.error.message;\r\n                        throw ERROR_FACTORY.create(\"token-unsubscribe-failed\" /* TOKEN_UNSUBSCRIBE_FAILED */, {\r\n                            errorInfo: message\r\n                        });\r\n                    }\r\n                    return [3 /*break*/, 6];\r\n                case 5:\r\n                    err_3 = _a.sent();\r\n                    throw ERROR_FACTORY.create(\"token-unsubscribe-failed\" /* TOKEN_UNSUBSCRIBE_FAILED */, {\r\n                        errorInfo: err_3\r\n                    });\r\n                case 6: return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\nfunction getEndpoint(_a) {\r\n    var projectId = _a.projectId;\r\n    return ENDPOINT + \"/projects/\" + projectId + \"/registrations\";\r\n}\r\nfunction getHeaders(_a) {\r\n    var appConfig = _a.appConfig, installations = _a.installations;\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var authToken;\r\n        return __generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0: return [4 /*yield*/, installations.getToken()];\r\n                case 1:\r\n                    authToken = _b.sent();\r\n                    return [2 /*return*/, new Headers({\r\n                            'Content-Type': 'application/json',\r\n                            Accept: 'application/json',\r\n                            'x-goog-api-key': appConfig.apiKey,\r\n                            'x-goog-firebase-installations-auth': \"FIS \" + authToken\r\n                        })];\r\n            }\r\n        });\r\n    });\r\n}\r\nfunction getBody(_a) {\r\n    var p256dh = _a.p256dh, auth = _a.auth, endpoint = _a.endpoint, vapidKey = _a.vapidKey;\r\n    var body = {\r\n        web: {\r\n            endpoint: endpoint,\r\n            auth: auth,\r\n            p256dh: p256dh\r\n        }\r\n    };\r\n    if (vapidKey !== DEFAULT_VAPID_KEY) {\r\n        body.web.applicationPubKey = vapidKey;\r\n    }\r\n    return body;\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n/** UpdateRegistration will be called once every week. */\r\nvar TOKEN_EXPIRATION_MS = 7 * 24 * 60 * 60 * 1000; // 7 days\r\nfunction getToken(firebaseDependencies, swRegistration, vapidKey) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var pushSubscription, tokenDetails, subscriptionOptions, e_1;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    if (Notification.permission !== 'granted') {\r\n                        throw ERROR_FACTORY.create(\"permission-blocked\" /* PERMISSION_BLOCKED */);\r\n                    }\r\n                    return [4 /*yield*/, getPushSubscription(swRegistration, vapidKey)];\r\n                case 1:\r\n                    pushSubscription = _a.sent();\r\n                    return [4 /*yield*/, dbGet(firebaseDependencies)];\r\n                case 2:\r\n                    tokenDetails = _a.sent();\r\n                    subscriptionOptions = {\r\n                        vapidKey: vapidKey,\r\n                        swScope: swRegistration.scope,\r\n                        endpoint: pushSubscription.endpoint,\r\n                        auth: arrayToBase64(pushSubscription.getKey('auth')),\r\n                        p256dh: arrayToBase64(pushSubscription.getKey('p256dh'))\r\n                    };\r\n                    if (!!tokenDetails) return [3 /*break*/, 3];\r\n                    // No token, get a new one.\r\n                    return [2 /*return*/, getNewToken(firebaseDependencies, subscriptionOptions)];\r\n                case 3:\r\n                    if (!!isTokenValid(tokenDetails.subscriptionOptions, subscriptionOptions)) return [3 /*break*/, 8];\r\n                    _a.label = 4;\r\n                case 4:\r\n                    _a.trys.push([4, 6, , 7]);\r\n                    return [4 /*yield*/, requestDeleteToken(firebaseDependencies, tokenDetails.token)];\r\n                case 5:\r\n                    _a.sent();\r\n                    return [3 /*break*/, 7];\r\n                case 6:\r\n                    e_1 = _a.sent();\r\n                    // Suppress errors because of #2364\r\n                    console.warn(e_1);\r\n                    return [3 /*break*/, 7];\r\n                case 7: return [2 /*return*/, getNewToken(firebaseDependencies, subscriptionOptions)];\r\n                case 8:\r\n                    if (Date.now() >= tokenDetails.createTime + TOKEN_EXPIRATION_MS) {\r\n                        // Weekly token refresh\r\n                        return [2 /*return*/, updateToken({\r\n                                token: tokenDetails.token,\r\n                                createTime: Date.now(),\r\n                                subscriptionOptions: subscriptionOptions\r\n                            }, firebaseDependencies, swRegistration)];\r\n                    }\r\n                    else {\r\n                        // Valid token, nothing to do.\r\n                        return [2 /*return*/, tokenDetails.token];\r\n                    }\r\n                case 9: return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\n/**\r\n * This method deletes the token from the database, unsubscribes the token from FCM, and unregisters\r\n * the push subscription if it exists.\r\n */\r\nfunction deleteToken(firebaseDependencies, swRegistration) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var tokenDetails, pushSubscription;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0: return [4 /*yield*/, dbGet(firebaseDependencies)];\r\n                case 1:\r\n                    tokenDetails = _a.sent();\r\n                    if (!tokenDetails) return [3 /*break*/, 4];\r\n                    return [4 /*yield*/, requestDeleteToken(firebaseDependencies, tokenDetails.token)];\r\n                case 2:\r\n                    _a.sent();\r\n                    return [4 /*yield*/, dbRemove(firebaseDependencies)];\r\n                case 3:\r\n                    _a.sent();\r\n                    _a.label = 4;\r\n                case 4: return [4 /*yield*/, swRegistration.pushManager.getSubscription()];\r\n                case 5:\r\n                    pushSubscription = _a.sent();\r\n                    if (pushSubscription) {\r\n                        return [2 /*return*/, pushSubscription.unsubscribe()];\r\n                    }\r\n                    // If there's no SW, consider it a success.\r\n                    return [2 /*return*/, true];\r\n            }\r\n        });\r\n    });\r\n}\r\nfunction updateToken(tokenDetails, firebaseDependencies, swRegistration) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var updatedToken, updatedTokenDetails, e_2;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    _a.trys.push([0, 3, , 5]);\r\n                    return [4 /*yield*/, requestUpdateToken(firebaseDependencies, tokenDetails)];\r\n                case 1:\r\n                    updatedToken = _a.sent();\r\n                    updatedTokenDetails = __assign(__assign({}, tokenDetails), { token: updatedToken, createTime: Date.now() });\r\n                    return [4 /*yield*/, dbSet(firebaseDependencies, updatedTokenDetails)];\r\n                case 2:\r\n                    _a.sent();\r\n                    return [2 /*return*/, updatedToken];\r\n                case 3:\r\n                    e_2 = _a.sent();\r\n                    return [4 /*yield*/, deleteToken(firebaseDependencies, swRegistration)];\r\n                case 4:\r\n                    _a.sent();\r\n                    throw e_2;\r\n                case 5: return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\nfunction getNewToken(firebaseDependencies, subscriptionOptions) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var token, tokenDetails;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0: return [4 /*yield*/, requestGetToken(firebaseDependencies, subscriptionOptions)];\r\n                case 1:\r\n                    token = _a.sent();\r\n                    tokenDetails = {\r\n                        token: token,\r\n                        createTime: Date.now(),\r\n                        subscriptionOptions: subscriptionOptions\r\n                    };\r\n                    return [4 /*yield*/, dbSet(firebaseDependencies, tokenDetails)];\r\n                case 2:\r\n                    _a.sent();\r\n                    return [2 /*return*/, tokenDetails.token];\r\n            }\r\n        });\r\n    });\r\n}\r\n/**\r\n * Gets a PushSubscription for the current user.\r\n */\r\nfunction getPushSubscription(swRegistration, vapidKey) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var subscription;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0: return [4 /*yield*/, swRegistration.pushManager.getSubscription()];\r\n                case 1:\r\n                    subscription = _a.sent();\r\n                    if (subscription) {\r\n                        return [2 /*return*/, subscription];\r\n                    }\r\n                    return [2 /*return*/, swRegistration.pushManager.subscribe({\r\n                            userVisibleOnly: true,\r\n                            // Chrome <= 75 doesn't support base64-encoded VAPID key. For backward compatibility, VAPID key\r\n                            // submitted to pushManager#subscribe must be of type Uint8Array.\r\n                            applicationServerKey: base64ToArray(vapidKey)\r\n                        })];\r\n            }\r\n        });\r\n    });\r\n}\r\n/**\r\n * Checks if the saved tokenDetails object matches the configuration provided.\r\n */\r\nfunction isTokenValid(dbOptions, currentOptions) {\r\n    var isVapidKeyEqual = currentOptions.vapidKey === dbOptions.vapidKey;\r\n    var isEndpointEqual = currentOptions.endpoint === dbOptions.endpoint;\r\n    var isAuthEqual = currentOptions.auth === dbOptions.auth;\r\n    var isP256dhEqual = currentOptions.p256dh === dbOptions.p256dh;\r\n    return isVapidKeyEqual && isEndpointEqual && isAuthEqual && isP256dhEqual;\r\n}\n\n/**\r\n * @license\r\n * Copyright 2020 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nfunction externalizePayload(internalPayload) {\r\n    var payload = {\r\n        from: internalPayload.from,\r\n        // eslint-disable-next-line camelcase\r\n        collapseKey: internalPayload.collapse_key,\r\n        // eslint-disable-next-line camelcase\r\n        messageId: internalPayload.fcm_message_id\r\n    };\r\n    propagateNotificationPayload(payload, internalPayload);\r\n    propagateDataPayload(payload, internalPayload);\r\n    propagateFcmOptions(payload, internalPayload);\r\n    return payload;\r\n}\r\nfunction propagateNotificationPayload(payload, messagePayloadInternal) {\r\n    if (!messagePayloadInternal.notification) {\r\n        return;\r\n    }\r\n    payload.notification = {};\r\n    var title = messagePayloadInternal.notification.title;\r\n    if (!!title) {\r\n        payload.notification.title = title;\r\n    }\r\n    var body = messagePayloadInternal.notification.body;\r\n    if (!!body) {\r\n        payload.notification.body = body;\r\n    }\r\n    var image = messagePayloadInternal.notification.image;\r\n    if (!!image) {\r\n        payload.notification.image = image;\r\n    }\r\n}\r\nfunction propagateDataPayload(payload, messagePayloadInternal) {\r\n    if (!messagePayloadInternal.data) {\r\n        return;\r\n    }\r\n    payload.data = messagePayloadInternal.data;\r\n}\r\nfunction propagateFcmOptions(payload, messagePayloadInternal) {\r\n    if (!messagePayloadInternal.fcmOptions) {\r\n        return;\r\n    }\r\n    payload.fcmOptions = {};\r\n    var link = messagePayloadInternal.fcmOptions.link;\r\n    if (!!link) {\r\n        payload.fcmOptions.link = link;\r\n    }\r\n    // eslint-disable-next-line camelcase\r\n    var analyticsLabel = messagePayloadInternal.fcmOptions.analytics_label;\r\n    if (!!analyticsLabel) {\r\n        payload.fcmOptions.analyticsLabel = analyticsLabel;\r\n    }\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nfunction isConsoleMessage(data) {\r\n    // This message has a campaign ID, meaning it was sent using the Firebase Console.\r\n    return typeof data === 'object' && !!data && CONSOLE_CAMPAIGN_ID in data;\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n/** Returns a promise that resolves after given time passes. */\r\nfunction sleep(ms) {\r\n    return new Promise(function (resolve) {\r\n        setTimeout(resolve, ms);\r\n    });\r\n}\n\n/**\r\n * @license\r\n * Copyright 2017 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nvar SwController = /** @class */ (function () {\r\n    function SwController(firebaseDependencies) {\r\n        var _this = this;\r\n        this.firebaseDependencies = firebaseDependencies;\r\n        // A boolean flag to determine wether an app is using onBackgroundMessage or\r\n        // setBackgroundMessageHandler. onBackgroundMessage will receive a MessagePayload regardless of if\r\n        // a notification is displayed. Whereas, setBackgroundMessageHandler will swallow the\r\n        // MessagePayload if a NotificationPayload is included.\r\n        this.isOnBackgroundMessageUsed = null;\r\n        this.vapidKey = null;\r\n        this.bgMessageHandler = null;\r\n        self.addEventListener('push', function (e) {\r\n            e.waitUntil(_this.onPush(e));\r\n        });\r\n        self.addEventListener('pushsubscriptionchange', function (e) {\r\n            e.waitUntil(_this.onSubChange(e));\r\n        });\r\n        self.addEventListener('notificationclick', function (e) {\r\n            e.waitUntil(_this.onNotificationClick(e));\r\n        });\r\n    }\r\n    Object.defineProperty(SwController.prototype, \"app\", {\r\n        get: function () {\r\n            return this.firebaseDependencies.app;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    /**\r\n     * @deprecated. Use onBackgroundMessage(nextOrObserver: NextFn<object> | Observer<object>):\r\n     * Unsubscribe instead.\r\n     *\r\n     * Calling setBackgroundMessageHandler will opt in to some specific behaviors.\r\n     *\r\n     * 1.) If a notification doesn't need to be shown due to a window already being visible, then push\r\n     * messages will be sent to the page. 2.) If a notification needs to be shown, and the message\r\n     * contains no notification data this method will be called and the promise it returns will be\r\n     * passed to event.waitUntil. If you do not set this callback then all push messages will let and\r\n     * the developer can handle them in a their own 'push' event callback\r\n     *\r\n     * @param callback The callback to be called when a push message is received and a notification\r\n     * must be shown. The callback will be given the data from the push message.\r\n     */\r\n    SwController.prototype.setBackgroundMessageHandler = function (callback) {\r\n        this.isOnBackgroundMessageUsed = false;\r\n        if (!callback || typeof callback !== 'function') {\r\n            throw ERROR_FACTORY.create(\"invalid-bg-handler\" /* INVALID_BG_HANDLER */);\r\n        }\r\n        this.bgMessageHandler = callback;\r\n    };\r\n    SwController.prototype.onBackgroundMessage = function (nextOrObserver) {\r\n        var _this = this;\r\n        this.isOnBackgroundMessageUsed = true;\r\n        this.bgMessageHandler = nextOrObserver;\r\n        return function () {\r\n            _this.bgMessageHandler = null;\r\n        };\r\n    };\r\n    // TODO: Remove getToken from SW Controller. Calling this from an old SW can cause all kinds of\r\n    // trouble.\r\n    SwController.prototype.getToken = function () {\r\n        var _a, _b;\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var tokenDetails;\r\n            return __generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        if (!!this.vapidKey) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, dbGet(this.firebaseDependencies)];\r\n                    case 1:\r\n                        tokenDetails = _c.sent();\r\n                        this.vapidKey =\r\n                            (_b = (_a = tokenDetails === null || tokenDetails === void 0 ? void 0 : tokenDetails.subscriptionOptions) === null || _a === void 0 ? void 0 : _a.vapidKey) !== null && _b !== void 0 ? _b : DEFAULT_VAPID_KEY;\r\n                        _c.label = 2;\r\n                    case 2: return [2 /*return*/, getToken(this.firebaseDependencies, self.registration, this.vapidKey)];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    // TODO: Remove deleteToken from SW Controller. Calling this from an old SW can cause all kinds of\r\n    // trouble.\r\n    SwController.prototype.deleteToken = function () {\r\n        return deleteToken(this.firebaseDependencies, self.registration);\r\n    };\r\n    SwController.prototype.requestPermission = function () {\r\n        throw ERROR_FACTORY.create(\"only-available-in-window\" /* AVAILABLE_IN_WINDOW */);\r\n    };\r\n    // TODO: Remove this together with getToken from SW Controller.\r\n    SwController.prototype.usePublicVapidKey = function (vapidKey) {\r\n        if (this.vapidKey !== null) {\r\n            throw ERROR_FACTORY.create(\"use-vapid-key-after-get-token\" /* USE_VAPID_KEY_AFTER_GET_TOKEN */);\r\n        }\r\n        if (typeof vapidKey !== 'string' || vapidKey.length === 0) {\r\n            throw ERROR_FACTORY.create(\"invalid-vapid-key\" /* INVALID_VAPID_KEY */);\r\n        }\r\n        this.vapidKey = vapidKey;\r\n    };\r\n    SwController.prototype.useServiceWorker = function () {\r\n        throw ERROR_FACTORY.create(\"only-available-in-window\" /* AVAILABLE_IN_WINDOW */);\r\n    };\r\n    SwController.prototype.onMessage = function () {\r\n        throw ERROR_FACTORY.create(\"only-available-in-window\" /* AVAILABLE_IN_WINDOW */);\r\n    };\r\n    SwController.prototype.onTokenRefresh = function () {\r\n        throw ERROR_FACTORY.create(\"only-available-in-window\" /* AVAILABLE_IN_WINDOW */);\r\n    };\r\n    /**\r\n     * A handler for push events that shows notifications based on the content of the payload.\r\n     *\r\n     * The payload must be a JSON-encoded Object with a `notification` key. The value of the\r\n     * `notification` property will be used as the NotificationOptions object passed to\r\n     * showNotification. Additionally, the `title` property of the notification object will be used as\r\n     * the title.\r\n     *\r\n     * If there is no notification data in the payload then no notification will be shown.\r\n     */\r\n    SwController.prototype.onPush = function (event) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var internalPayload, clientList, isNotificationShown, payload;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        internalPayload = getMessagePayloadInternal(event);\r\n                        if (!internalPayload) {\r\n                            console.debug(TAG +\r\n                                'failed to get parsed MessagePayload from the PushEvent. Skip handling the push.');\r\n                            return [2 /*return*/];\r\n                        }\r\n                        return [4 /*yield*/, getClientList()];\r\n                    case 1:\r\n                        clientList = _a.sent();\r\n                        if (hasVisibleClients(clientList)) {\r\n                            return [2 /*return*/, sendMessagePayloadInternalToWindows(clientList, internalPayload)];\r\n                        }\r\n                        isNotificationShown = false;\r\n                        if (!!!internalPayload.notification) return [3 /*break*/, 3];\r\n                        return [4 /*yield*/, showNotification(wrapInternalPayload(internalPayload))];\r\n                    case 2:\r\n                        _a.sent();\r\n                        isNotificationShown = true;\r\n                        _a.label = 3;\r\n                    case 3:\r\n                        // MessagePayload is only passed to `onBackgroundMessage`. Skip passing MessagePayload for\r\n                        // the legacy `setBackgroundMessageHandler` to preserve the SDK behaviors.\r\n                        if (isNotificationShown === true &&\r\n                            this.isOnBackgroundMessageUsed === false) {\r\n                            return [2 /*return*/];\r\n                        }\r\n                        if (!!this.bgMessageHandler) {\r\n                            payload = externalizePayload(internalPayload);\r\n                            if (typeof this.bgMessageHandler === 'function') {\r\n                                this.bgMessageHandler(payload);\r\n                            }\r\n                            else {\r\n                                this.bgMessageHandler.next(payload);\r\n                            }\r\n                        }\r\n                        // wait briefly to allow onBackgroundMessage to complete\r\n                        return [4 /*yield*/, sleep(BACKGROUND_HANDLE_EXECUTION_TIME_LIMIT_MS)];\r\n                    case 4:\r\n                        // wait briefly to allow onBackgroundMessage to complete\r\n                        _a.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    SwController.prototype.onSubChange = function (event) {\r\n        var _a, _b;\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var newSubscription, tokenDetails;\r\n            return __generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        newSubscription = event.newSubscription;\r\n                        if (!!newSubscription) return [3 /*break*/, 2];\r\n                        // Subscription revoked, delete token\r\n                        return [4 /*yield*/, deleteToken(this.firebaseDependencies, self.registration)];\r\n                    case 1:\r\n                        // Subscription revoked, delete token\r\n                        _c.sent();\r\n                        return [2 /*return*/];\r\n                    case 2: return [4 /*yield*/, dbGet(this.firebaseDependencies)];\r\n                    case 3:\r\n                        tokenDetails = _c.sent();\r\n                        return [4 /*yield*/, deleteToken(this.firebaseDependencies, self.registration)];\r\n                    case 4:\r\n                        _c.sent();\r\n                        return [4 /*yield*/, getToken(this.firebaseDependencies, self.registration, (_b = (_a = tokenDetails === null || tokenDetails === void 0 ? void 0 : tokenDetails.subscriptionOptions) === null || _a === void 0 ? void 0 : _a.vapidKey) !== null && _b !== void 0 ? _b : DEFAULT_VAPID_KEY)];\r\n                    case 5:\r\n                        _c.sent();\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    SwController.prototype.onNotificationClick = function (event) {\r\n        var _a, _b;\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var internalPayload, link, url, originUrl, client;\r\n            return __generator(this, function (_c) {\r\n                switch (_c.label) {\r\n                    case 0:\r\n                        internalPayload = (_b = (_a = event.notification) === null || _a === void 0 ? void 0 : _a.data) === null || _b === void 0 ? void 0 : _b[FCM_MSG];\r\n                        if (!internalPayload) {\r\n                            return [2 /*return*/];\r\n                        }\r\n                        else if (event.action) {\r\n                            // User clicked on an action button. This will allow developers to act on action button clicks\r\n                            // by using a custom onNotificationClick listener that they define.\r\n                            return [2 /*return*/];\r\n                        }\r\n                        // Prevent other listeners from receiving the event\r\n                        event.stopImmediatePropagation();\r\n                        event.notification.close();\r\n                        link = getLink(internalPayload);\r\n                        if (!link) {\r\n                            return [2 /*return*/];\r\n                        }\r\n                        url = new URL(link, self.location.href);\r\n                        originUrl = new URL(self.location.origin);\r\n                        if (url.host !== originUrl.host) {\r\n                            return [2 /*return*/];\r\n                        }\r\n                        return [4 /*yield*/, getWindowClient(url)];\r\n                    case 1:\r\n                        client = _c.sent();\r\n                        if (!!client) return [3 /*break*/, 4];\r\n                        return [4 /*yield*/, self.clients.openWindow(link)];\r\n                    case 2:\r\n                        client = _c.sent();\r\n                        // Wait three seconds for the client to initialize and set up the message handler so that it\r\n                        // can receive the message.\r\n                        return [4 /*yield*/, sleep(FOREGROUND_HANDLE_PREPARATION_TIME_MS)];\r\n                    case 3:\r\n                        // Wait three seconds for the client to initialize and set up the message handler so that it\r\n                        // can receive the message.\r\n                        _c.sent();\r\n                        return [3 /*break*/, 6];\r\n                    case 4: return [4 /*yield*/, client.focus()];\r\n                    case 5:\r\n                        client = _c.sent();\r\n                        _c.label = 6;\r\n                    case 6:\r\n                        if (!client) {\r\n                            // Window Client will not be returned if it's for a third party origin.\r\n                            return [2 /*return*/];\r\n                        }\r\n                        internalPayload.messageType = MessageType.NOTIFICATION_CLICKED;\r\n                        internalPayload.isFirebaseMessaging = true;\r\n                        return [2 /*return*/, client.postMessage(internalPayload)];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return SwController;\r\n}());\r\nfunction wrapInternalPayload(internalPayload) {\r\n    var _a;\r\n    var wrappedInternalPayload = __assign({}, internalPayload.notification);\r\n    // Put the message payload under FCM_MSG name so we can identify the notification as being an FCM\r\n    // notification vs a notification from somewhere else (i.e. normal web push or developer generated\r\n    // notification).\r\n    wrappedInternalPayload.data = (_a = {},\r\n        _a[FCM_MSG] = internalPayload,\r\n        _a);\r\n    return wrappedInternalPayload;\r\n}\r\nfunction getMessagePayloadInternal(_a) {\r\n    var data = _a.data;\r\n    if (!data) {\r\n        return null;\r\n    }\r\n    try {\r\n        return data.json();\r\n    }\r\n    catch (err) {\r\n        // Not JSON so not an FCM message.\r\n        return null;\r\n    }\r\n}\r\n/**\r\n * @param url The URL to look for when focusing a client.\r\n * @return Returns an existing window client or a newly opened WindowClient.\r\n */\r\nfunction getWindowClient(url) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var clientList, clientList_1, clientList_1_1, client, clientUrl;\r\n        var e_1, _a;\r\n        return __generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0: return [4 /*yield*/, getClientList()];\r\n                case 1:\r\n                    clientList = _b.sent();\r\n                    try {\r\n                        for (clientList_1 = __values(clientList), clientList_1_1 = clientList_1.next(); !clientList_1_1.done; clientList_1_1 = clientList_1.next()) {\r\n                            client = clientList_1_1.value;\r\n                            clientUrl = new URL(client.url, self.location.href);\r\n                            if (url.host === clientUrl.host) {\r\n                                return [2 /*return*/, client];\r\n                            }\r\n                        }\r\n                    }\r\n                    catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n                    finally {\r\n                        try {\r\n                            if (clientList_1_1 && !clientList_1_1.done && (_a = clientList_1.return)) _a.call(clientList_1);\r\n                        }\r\n                        finally { if (e_1) throw e_1.error; }\r\n                    }\r\n                    return [2 /*return*/, null];\r\n            }\r\n        });\r\n    });\r\n}\r\n/**\r\n * @returns If there is currently a visible WindowClient, this method will resolve to true,\r\n * otherwise false.\r\n */\r\nfunction hasVisibleClients(clientList) {\r\n    return clientList.some(function (client) {\r\n        return client.visibilityState === 'visible' &&\r\n            // Ignore chrome-extension clients as that matches the background pages of extensions, which\r\n            // are always considered visible for some reason.\r\n            !client.url.startsWith('chrome-extension://');\r\n    });\r\n}\r\nfunction sendMessagePayloadInternalToWindows(clientList, internalPayload) {\r\n    var e_2, _a;\r\n    internalPayload.isFirebaseMessaging = true;\r\n    internalPayload.messageType = MessageType.PUSH_RECEIVED;\r\n    try {\r\n        for (var clientList_2 = __values(clientList), clientList_2_1 = clientList_2.next(); !clientList_2_1.done; clientList_2_1 = clientList_2.next()) {\r\n            var client = clientList_2_1.value;\r\n            client.postMessage(internalPayload);\r\n        }\r\n    }\r\n    catch (e_2_1) { e_2 = { error: e_2_1 }; }\r\n    finally {\r\n        try {\r\n            if (clientList_2_1 && !clientList_2_1.done && (_a = clientList_2.return)) _a.call(clientList_2);\r\n        }\r\n        finally { if (e_2) throw e_2.error; }\r\n    }\r\n}\r\nfunction getClientList() {\r\n    return self.clients.matchAll({\r\n        type: 'window',\r\n        includeUncontrolled: true\r\n        // TS doesn't know that \"type: 'window'\" means it'll return WindowClient[]\r\n    });\r\n}\r\nfunction showNotification(notificationPayloadInternal) {\r\n    var _a;\r\n    // Note: Firefox does not support the maxActions property.\r\n    // https://developer.mozilla.org/en-US/docs/Web/API/notification/maxActions\r\n    var actions = notificationPayloadInternal.actions;\r\n    var maxActions = Notification.maxActions;\r\n    if (actions && maxActions && actions.length > maxActions) {\r\n        console.warn(\"This browser only supports \" + maxActions + \" actions. The remaining actions will not be displayed.\");\r\n    }\r\n    return self.registration.showNotification(\r\n    /* title= */ (_a = notificationPayloadInternal.title) !== null && _a !== void 0 ? _a : '', notificationPayloadInternal);\r\n}\r\nfunction getLink(payload) {\r\n    var _a, _b, _c;\r\n    // eslint-disable-next-line camelcase\r\n    var link = (_b = (_a = payload.fcmOptions) === null || _a === void 0 ? void 0 : _a.link) !== null && _b !== void 0 ? _b : (_c = payload.notification) === null || _c === void 0 ? void 0 : _c.click_action;\r\n    if (link) {\r\n        return link;\r\n    }\r\n    if (isConsoleMessage(payload.data)) {\r\n        // Notification created in the Firebase Console. Redirect to origin.\r\n        return self.location.origin;\r\n    }\r\n    else {\r\n        return null;\r\n    }\r\n}\n\n/**\r\n * @license\r\n * Copyright 2017 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nvar WindowController = /** @class */ (function () {\r\n    function WindowController(firebaseDependencies) {\r\n        var _this = this;\r\n        this.firebaseDependencies = firebaseDependencies;\r\n        this.vapidKey = null;\r\n        this.onMessageCallback = null;\r\n        navigator.serviceWorker.addEventListener('message', function (e) {\r\n            return _this.messageEventListener(e);\r\n        });\r\n    }\r\n    Object.defineProperty(WindowController.prototype, \"app\", {\r\n        get: function () {\r\n            return this.firebaseDependencies.app;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    WindowController.prototype.messageEventListener = function (event) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var internalPayload, dataPayload;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        internalPayload = event.data;\r\n                        if (!internalPayload.isFirebaseMessaging) {\r\n                            return [2 /*return*/];\r\n                        }\r\n                        // onMessageCallback is either a function or observer/subscriber.\r\n                        // TODO: in the modularization release, have onMessage handle type MessagePayload as supposed to\r\n                        // the legacy payload where some fields are in snake cases.\r\n                        if (this.onMessageCallback &&\r\n                            internalPayload.messageType === MessageType.PUSH_RECEIVED) {\r\n                            if (typeof this.onMessageCallback === 'function') {\r\n                                this.onMessageCallback(stripInternalFields(Object.assign({}, internalPayload)));\r\n                            }\r\n                            else {\r\n                                this.onMessageCallback.next(Object.assign({}, internalPayload));\r\n                            }\r\n                        }\r\n                        dataPayload = internalPayload.data;\r\n                        if (!(isConsoleMessage(dataPayload) &&\r\n                            dataPayload[CONSOLE_CAMPAIGN_ANALYTICS_ENABLED] === '1')) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this.logEvent(internalPayload.messageType, dataPayload)];\r\n                    case 1:\r\n                        _a.sent();\r\n                        _a.label = 2;\r\n                    case 2: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WindowController.prototype.getVapidKey = function () {\r\n        return this.vapidKey;\r\n    };\r\n    WindowController.prototype.getSwReg = function () {\r\n        return this.swRegistration;\r\n    };\r\n    WindowController.prototype.getToken = function (options) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!(Notification.permission === 'default')) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, Notification.requestPermission()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        _a.label = 2;\r\n                    case 2:\r\n                        if (Notification.permission !== 'granted') {\r\n                            throw ERROR_FACTORY.create(\"permission-blocked\" /* PERMISSION_BLOCKED */);\r\n                        }\r\n                        return [4 /*yield*/, this.updateVapidKey(options === null || options === void 0 ? void 0 : options.vapidKey)];\r\n                    case 3:\r\n                        _a.sent();\r\n                        return [4 /*yield*/, this.updateSwReg(options === null || options === void 0 ? void 0 : options.serviceWorkerRegistration)];\r\n                    case 4:\r\n                        _a.sent();\r\n                        return [2 /*return*/, getToken(this.firebaseDependencies, this.swRegistration, this.vapidKey)];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WindowController.prototype.updateVapidKey = function (vapidKey) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            return __generator(this, function (_a) {\r\n                if (!!vapidKey) {\r\n                    this.vapidKey = vapidKey;\r\n                }\r\n                else if (!this.vapidKey) {\r\n                    this.vapidKey = DEFAULT_VAPID_KEY;\r\n                }\r\n                return [2 /*return*/];\r\n            });\r\n        });\r\n    };\r\n    WindowController.prototype.updateSwReg = function (swRegistration) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!(!swRegistration && !this.swRegistration)) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this.registerDefaultSw()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        _a.label = 2;\r\n                    case 2:\r\n                        if (!swRegistration && !!this.swRegistration) {\r\n                            return [2 /*return*/];\r\n                        }\r\n                        if (!(swRegistration instanceof ServiceWorkerRegistration)) {\r\n                            throw ERROR_FACTORY.create(\"invalid-sw-registration\" /* INVALID_SW_REGISTRATION */);\r\n                        }\r\n                        this.swRegistration = swRegistration;\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WindowController.prototype.registerDefaultSw = function () {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var _a, e_1;\r\n            return __generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        _b.trys.push([0, 2, , 3]);\r\n                        _a = this;\r\n                        return [4 /*yield*/, navigator.serviceWorker.register(DEFAULT_SW_PATH, {\r\n                                scope: DEFAULT_SW_SCOPE\r\n                            })];\r\n                    case 1:\r\n                        _a.swRegistration = _b.sent();\r\n                        // The timing when browser updates sw when sw has an update is unreliable by my experiment. It\r\n                        // leads to version conflict when the SDK upgrades to a newer version in the main page, but sw\r\n                        // is stuck with the old version. For example,\r\n                        // https://github.com/firebase/firebase-js-sdk/issues/2590 The following line reliably updates\r\n                        // sw if there was an update.\r\n                        this.swRegistration.update().catch(function () {\r\n                            /* it is non blocking and we don't care if it failed */\r\n                        });\r\n                        return [3 /*break*/, 3];\r\n                    case 2:\r\n                        e_1 = _b.sent();\r\n                        throw ERROR_FACTORY.create(\"failed-service-worker-registration\" /* FAILED_DEFAULT_REGISTRATION */, {\r\n                            browserErrorMessage: e_1.message\r\n                        });\r\n                    case 3: return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    WindowController.prototype.deleteToken = function () {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!!this.swRegistration) return [3 /*break*/, 2];\r\n                        return [4 /*yield*/, this.registerDefaultSw()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        _a.label = 2;\r\n                    case 2: return [2 /*return*/, deleteToken(this.firebaseDependencies, this.swRegistration)];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * Request permission if it is not currently granted.\r\n     *\r\n     * @return Resolves if the permission was granted, rejects otherwise.\r\n     *\r\n     * @deprecated Use Notification.requestPermission() instead.\r\n     * https://developer.mozilla.org/en-US/docs/Web/API/Notification/requestPermission\r\n     */\r\n    WindowController.prototype.requestPermission = function () {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var permissionResult;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (Notification.permission === 'granted') {\r\n                            return [2 /*return*/];\r\n                        }\r\n                        return [4 /*yield*/, Notification.requestPermission()];\r\n                    case 1:\r\n                        permissionResult = _a.sent();\r\n                        if (permissionResult === 'granted') {\r\n                            return [2 /*return*/];\r\n                        }\r\n                        else if (permissionResult === 'denied') {\r\n                            throw ERROR_FACTORY.create(\"permission-blocked\" /* PERMISSION_BLOCKED */);\r\n                        }\r\n                        else {\r\n                            throw ERROR_FACTORY.create(\"permission-default\" /* PERMISSION_DEFAULT */);\r\n                        }\r\n                }\r\n            });\r\n        });\r\n    };\r\n    /**\r\n     * @deprecated. Use getToken(options?: {vapidKey?: string; serviceWorkerRegistration?:\r\n     * ServiceWorkerRegistration;}): Promise<string> instead.\r\n     */\r\n    WindowController.prototype.usePublicVapidKey = function (vapidKey) {\r\n        if (this.vapidKey !== null) {\r\n            throw ERROR_FACTORY.create(\"use-vapid-key-after-get-token\" /* USE_VAPID_KEY_AFTER_GET_TOKEN */);\r\n        }\r\n        if (typeof vapidKey !== 'string' || vapidKey.length === 0) {\r\n            throw ERROR_FACTORY.create(\"invalid-vapid-key\" /* INVALID_VAPID_KEY */);\r\n        }\r\n        this.vapidKey = vapidKey;\r\n    };\r\n    /**\r\n     * @deprecated. Use getToken(options?: {vapidKey?: string; serviceWorkerRegistration?:\r\n     * ServiceWorkerRegistration;}): Promise<string> instead.\r\n     */\r\n    WindowController.prototype.useServiceWorker = function (swRegistration) {\r\n        if (!(swRegistration instanceof ServiceWorkerRegistration)) {\r\n            throw ERROR_FACTORY.create(\"invalid-sw-registration\" /* INVALID_SW_REGISTRATION */);\r\n        }\r\n        if (this.swRegistration) {\r\n            throw ERROR_FACTORY.create(\"use-sw-after-get-token\" /* USE_SW_AFTER_GET_TOKEN */);\r\n        }\r\n        this.swRegistration = swRegistration;\r\n    };\r\n    /**\r\n     * @param nextOrObserver An observer object or a function triggered on message.\r\n     *\r\n     * @return The unsubscribe function for the observer.\r\n     */\r\n    WindowController.prototype.onMessage = function (nextOrObserver) {\r\n        var _this = this;\r\n        this.onMessageCallback = nextOrObserver;\r\n        return function () {\r\n            _this.onMessageCallback = null;\r\n        };\r\n    };\r\n    WindowController.prototype.setBackgroundMessageHandler = function () {\r\n        throw ERROR_FACTORY.create(\"only-available-in-sw\" /* AVAILABLE_IN_SW */);\r\n    };\r\n    WindowController.prototype.onBackgroundMessage = function () {\r\n        throw ERROR_FACTORY.create(\"only-available-in-sw\" /* AVAILABLE_IN_SW */);\r\n    };\r\n    /**\r\n     * @deprecated No-op. It was initially designed with token rotation requests from server in mind.\r\n     * However, the plan to implement such feature was abandoned.\r\n     */\r\n    WindowController.prototype.onTokenRefresh = function () {\r\n        return function () { };\r\n    };\r\n    WindowController.prototype.logEvent = function (messageType, data) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var eventType, analytics;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        eventType = getEventType(messageType);\r\n                        return [4 /*yield*/, this.firebaseDependencies.analyticsProvider.get()];\r\n                    case 1:\r\n                        analytics = _a.sent();\r\n                        analytics.logEvent(eventType, {\r\n                            /* eslint-disable camelcase */\r\n                            message_id: data[CONSOLE_CAMPAIGN_ID],\r\n                            message_name: data[CONSOLE_CAMPAIGN_NAME],\r\n                            message_time: data[CONSOLE_CAMPAIGN_TIME],\r\n                            message_device_time: Math.floor(Date.now() / 1000)\r\n                            /* eslint-enable camelcase */\r\n                        });\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    return WindowController;\r\n}());\r\nfunction getEventType(messageType) {\r\n    switch (messageType) {\r\n        case MessageType.NOTIFICATION_CLICKED:\r\n            return 'notification_open';\r\n        case MessageType.PUSH_RECEIVED:\r\n            return 'notification_foreground';\r\n        default:\r\n            throw new Error();\r\n    }\r\n}\r\nfunction stripInternalFields(internalPayload) {\r\n    delete internalPayload.messageType;\r\n    delete internalPayload.isFirebaseMessaging;\r\n    return internalPayload;\r\n}\n\n/**\r\n * @license\r\n * Copyright 2019 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nfunction extractAppConfig(app) {\r\n    var e_1, _a;\r\n    if (!app || !app.options) {\r\n        throw getMissingValueError('App Configuration Object');\r\n    }\r\n    if (!app.name) {\r\n        throw getMissingValueError('App Name');\r\n    }\r\n    // Required app config keys\r\n    var configKeys = [\r\n        'projectId',\r\n        'apiKey',\r\n        'appId',\r\n        'messagingSenderId'\r\n    ];\r\n    var options = app.options;\r\n    try {\r\n        for (var configKeys_1 = __values(configKeys), configKeys_1_1 = configKeys_1.next(); !configKeys_1_1.done; configKeys_1_1 = configKeys_1.next()) {\r\n            var keyName = configKeys_1_1.value;\r\n            if (!options[keyName]) {\r\n                throw getMissingValueError(keyName);\r\n            }\r\n        }\r\n    }\r\n    catch (e_1_1) { e_1 = { error: e_1_1 }; }\r\n    finally {\r\n        try {\r\n            if (configKeys_1_1 && !configKeys_1_1.done && (_a = configKeys_1.return)) _a.call(configKeys_1);\r\n        }\r\n        finally { if (e_1) throw e_1.error; }\r\n    }\r\n    return {\r\n        appName: app.name,\r\n        projectId: options.projectId,\r\n        apiKey: options.apiKey,\r\n        appId: options.appId,\r\n        senderId: options.messagingSenderId\r\n    };\r\n}\r\nfunction getMissingValueError(valueName) {\r\n    return ERROR_FACTORY.create(\"missing-app-config-values\" /* MISSING_APP_CONFIG_VALUES */, {\r\n        valueName: valueName\r\n    });\r\n}\n\n/**\r\n * @license\r\n * Copyright 2017 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nvar MESSAGING_NAME = 'messaging';\r\nfunction factoryMethod(container) {\r\n    // Dependencies.\r\n    var app = container.getProvider('app').getImmediate();\r\n    var appConfig = extractAppConfig(app);\r\n    var installations = container.getProvider('installations').getImmediate();\r\n    var analyticsProvider = container.getProvider('analytics-internal');\r\n    var firebaseDependencies = {\r\n        app: app,\r\n        appConfig: appConfig,\r\n        installations: installations,\r\n        analyticsProvider: analyticsProvider\r\n    };\r\n    if (!isSupported()) {\r\n        throw ERROR_FACTORY.create(\"unsupported-browser\" /* UNSUPPORTED_BROWSER */);\r\n    }\r\n    if (self && 'ServiceWorkerGlobalScope' in self) {\r\n        // Running in ServiceWorker context\r\n        return new SwController(firebaseDependencies);\r\n    }\r\n    else {\r\n        // Assume we are in the window context.\r\n        return new WindowController(firebaseDependencies);\r\n    }\r\n}\r\nvar NAMESPACE_EXPORTS = {\r\n    isSupported: isSupported\r\n};\r\nfirebase.INTERNAL.registerComponent(new Component(MESSAGING_NAME, factoryMethod, \"PUBLIC\" /* PUBLIC */).setServiceProps(NAMESPACE_EXPORTS));\r\nfunction isSupported() {\r\n    if (self && 'ServiceWorkerGlobalScope' in self) {\r\n        // Running in ServiceWorker context\r\n        return isSWControllerSupported();\r\n    }\r\n    else {\r\n        // Assume we are in the window context.\r\n        return isWindowControllerSupported();\r\n    }\r\n}\r\n/**\r\n * Checks to see if the required APIs exist.\r\n */\r\nfunction isWindowControllerSupported() {\r\n    return ('indexedDB' in window &&\r\n        indexedDB !== null &&\r\n        navigator.cookieEnabled &&\r\n        'serviceWorker' in navigator &&\r\n        'PushManager' in window &&\r\n        'Notification' in window &&\r\n        'fetch' in window &&\r\n        ServiceWorkerRegistration.prototype.hasOwnProperty('showNotification') &&\r\n        PushSubscription.prototype.hasOwnProperty('getKey'));\r\n}\r\n/**\r\n * Checks to see if the required APIs exist within SW Context.\r\n */\r\nfunction isSWControllerSupported() {\r\n    return ('indexedDB' in self &&\r\n        indexedDB !== null &&\r\n        'PushManager' in self &&\r\n        'Notification' in self &&\r\n        ServiceWorkerRegistration.prototype.hasOwnProperty('showNotification') &&\r\n        PushSubscription.prototype.hasOwnProperty('getKey'));\r\n}\n//# sourceMappingURL=index.esm.js.map\n","(function (global, factory) {\n  typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports) :\n  typeof define === 'function' && define.amd ? define(['exports'], factory) :\n  (global = global || self, factory(global.idb = {}));\n}(this, function (exports) { 'use strict';\n\n  function toArray(arr) {\n    return Array.prototype.slice.call(arr);\n  }\n\n  function promisifyRequest(request) {\n    return new Promise(function(resolve, reject) {\n      request.onsuccess = function() {\n        resolve(request.result);\n      };\n\n      request.onerror = function() {\n        reject(request.error);\n      };\n    });\n  }\n\n  function promisifyRequestCall(obj, method, args) {\n    var request;\n    var p = new Promise(function(resolve, reject) {\n      request = obj[method].apply(obj, args);\n      promisifyRequest(request).then(resolve, reject);\n    });\n\n    p.request = request;\n    return p;\n  }\n\n  function promisifyCursorRequestCall(obj, method, args) {\n    var p = promisifyRequestCall(obj, method, args);\n    return p.then(function(value) {\n      if (!value) return;\n      return new Cursor(value, p.request);\n    });\n  }\n\n  function proxyProperties(ProxyClass, targetProp, properties) {\n    properties.forEach(function(prop) {\n      Object.defineProperty(ProxyClass.prototype, prop, {\n        get: function() {\n          return this[targetProp][prop];\n        },\n        set: function(val) {\n          this[targetProp][prop] = val;\n        }\n      });\n    });\n  }\n\n  function proxyRequestMethods(ProxyClass, targetProp, Constructor, properties) {\n    properties.forEach(function(prop) {\n      if (!(prop in Constructor.prototype)) return;\n      ProxyClass.prototype[prop] = function() {\n        return promisifyRequestCall(this[targetProp], prop, arguments);\n      };\n    });\n  }\n\n  function proxyMethods(ProxyClass, targetProp, Constructor, properties) {\n    properties.forEach(function(prop) {\n      if (!(prop in Constructor.prototype)) return;\n      ProxyClass.prototype[prop] = function() {\n        return this[targetProp][prop].apply(this[targetProp], arguments);\n      };\n    });\n  }\n\n  function proxyCursorRequestMethods(ProxyClass, targetProp, Constructor, properties) {\n    properties.forEach(function(prop) {\n      if (!(prop in Constructor.prototype)) return;\n      ProxyClass.prototype[prop] = function() {\n        return promisifyCursorRequestCall(this[targetProp], prop, arguments);\n      };\n    });\n  }\n\n  function Index(index) {\n    this._index = index;\n  }\n\n  proxyProperties(Index, '_index', [\n    'name',\n    'keyPath',\n    'multiEntry',\n    'unique'\n  ]);\n\n  proxyRequestMethods(Index, '_index', IDBIndex, [\n    'get',\n    'getKey',\n    'getAll',\n    'getAllKeys',\n    'count'\n  ]);\n\n  proxyCursorRequestMethods(Index, '_index', IDBIndex, [\n    'openCursor',\n    'openKeyCursor'\n  ]);\n\n  function Cursor(cursor, request) {\n    this._cursor = cursor;\n    this._request = request;\n  }\n\n  proxyProperties(Cursor, '_cursor', [\n    'direction',\n    'key',\n    'primaryKey',\n    'value'\n  ]);\n\n  proxyRequestMethods(Cursor, '_cursor', IDBCursor, [\n    'update',\n    'delete'\n  ]);\n\n  // proxy 'next' methods\n  ['advance', 'continue', 'continuePrimaryKey'].forEach(function(methodName) {\n    if (!(methodName in IDBCursor.prototype)) return;\n    Cursor.prototype[methodName] = function() {\n      var cursor = this;\n      var args = arguments;\n      return Promise.resolve().then(function() {\n        cursor._cursor[methodName].apply(cursor._cursor, args);\n        return promisifyRequest(cursor._request).then(function(value) {\n          if (!value) return;\n          return new Cursor(value, cursor._request);\n        });\n      });\n    };\n  });\n\n  function ObjectStore(store) {\n    this._store = store;\n  }\n\n  ObjectStore.prototype.createIndex = function() {\n    return new Index(this._store.createIndex.apply(this._store, arguments));\n  };\n\n  ObjectStore.prototype.index = function() {\n    return new Index(this._store.index.apply(this._store, arguments));\n  };\n\n  proxyProperties(ObjectStore, '_store', [\n    'name',\n    'keyPath',\n    'indexNames',\n    'autoIncrement'\n  ]);\n\n  proxyRequestMethods(ObjectStore, '_store', IDBObjectStore, [\n    'put',\n    'add',\n    'delete',\n    'clear',\n    'get',\n    'getAll',\n    'getKey',\n    'getAllKeys',\n    'count'\n  ]);\n\n  proxyCursorRequestMethods(ObjectStore, '_store', IDBObjectStore, [\n    'openCursor',\n    'openKeyCursor'\n  ]);\n\n  proxyMethods(ObjectStore, '_store', IDBObjectStore, [\n    'deleteIndex'\n  ]);\n\n  function Transaction(idbTransaction) {\n    this._tx = idbTransaction;\n    this.complete = new Promise(function(resolve, reject) {\n      idbTransaction.oncomplete = function() {\n        resolve();\n      };\n      idbTransaction.onerror = function() {\n        reject(idbTransaction.error);\n      };\n      idbTransaction.onabort = function() {\n        reject(idbTransaction.error);\n      };\n    });\n  }\n\n  Transaction.prototype.objectStore = function() {\n    return new ObjectStore(this._tx.objectStore.apply(this._tx, arguments));\n  };\n\n  proxyProperties(Transaction, '_tx', [\n    'objectStoreNames',\n    'mode'\n  ]);\n\n  proxyMethods(Transaction, '_tx', IDBTransaction, [\n    'abort'\n  ]);\n\n  function UpgradeDB(db, oldVersion, transaction) {\n    this._db = db;\n    this.oldVersion = oldVersion;\n    this.transaction = new Transaction(transaction);\n  }\n\n  UpgradeDB.prototype.createObjectStore = function() {\n    return new ObjectStore(this._db.createObjectStore.apply(this._db, arguments));\n  };\n\n  proxyProperties(UpgradeDB, '_db', [\n    'name',\n    'version',\n    'objectStoreNames'\n  ]);\n\n  proxyMethods(UpgradeDB, '_db', IDBDatabase, [\n    'deleteObjectStore',\n    'close'\n  ]);\n\n  function DB(db) {\n    this._db = db;\n  }\n\n  DB.prototype.transaction = function() {\n    return new Transaction(this._db.transaction.apply(this._db, arguments));\n  };\n\n  proxyProperties(DB, '_db', [\n    'name',\n    'version',\n    'objectStoreNames'\n  ]);\n\n  proxyMethods(DB, '_db', IDBDatabase, [\n    'close'\n  ]);\n\n  // Add cursor iterators\n  // TODO: remove this once browsers do the right thing with promises\n  ['openCursor', 'openKeyCursor'].forEach(function(funcName) {\n    [ObjectStore, Index].forEach(function(Constructor) {\n      // Don't create iterateKeyCursor if openKeyCursor doesn't exist.\n      if (!(funcName in Constructor.prototype)) return;\n\n      Constructor.prototype[funcName.replace('open', 'iterate')] = function() {\n        var args = toArray(arguments);\n        var callback = args[args.length - 1];\n        var nativeObject = this._store || this._index;\n        var request = nativeObject[funcName].apply(nativeObject, args.slice(0, -1));\n        request.onsuccess = function() {\n          callback(request.result);\n        };\n      };\n    });\n  });\n\n  // polyfill getAll\n  [Index, ObjectStore].forEach(function(Constructor) {\n    if (Constructor.prototype.getAll) return;\n    Constructor.prototype.getAll = function(query, count) {\n      var instance = this;\n      var items = [];\n\n      return new Promise(function(resolve) {\n        instance.iterateCursor(query, function(cursor) {\n          if (!cursor) {\n            resolve(items);\n            return;\n          }\n          items.push(cursor.value);\n\n          if (count !== undefined && items.length == count) {\n            resolve(items);\n            return;\n          }\n          cursor.continue();\n        });\n      });\n    };\n  });\n\n  function openDb(name, version, upgradeCallback) {\n    var p = promisifyRequestCall(indexedDB, 'open', [name, version]);\n    var request = p.request;\n\n    if (request) {\n      request.onupgradeneeded = function(event) {\n        if (upgradeCallback) {\n          upgradeCallback(new UpgradeDB(request.result, event.oldVersion, request.transaction));\n        }\n      };\n    }\n\n    return p.then(function(db) {\n      return new DB(db);\n    });\n  }\n\n  function deleteDb(name) {\n    return promisifyRequestCall(indexedDB, 'deleteDatabase', [name]);\n  }\n\n  exports.openDb = openDb;\n  exports.deleteDb = deleteDb;\n\n  Object.defineProperty(exports, '__esModule', { value: true });\n\n}));\n"]}